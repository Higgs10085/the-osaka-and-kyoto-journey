<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>騎士團討伐魔王遠征隊</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;700&family=Great+Vibes&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        serif: ['"Shippori Mincho"', 'serif'],
                        cursive: ['"Great Vibes"', 'cursive']
                    },
                    colors: {
                        magic: {
                            dark: '#0f172a', 
                            night: '#2E3338',
                            mist: 'rgba(255, 255, 255, 0.08)', 
                            ice: '#a5f3fc',
                            blue: '#A7D7FF',
                            silver: '#e2e8f0', 
                            glow: 'rgba(165, 243, 252, 0.4)', 
                            active: '#ffffff',
                            danger: '#ef4444',
                        },
                    },
                    animation: {
                        'spin-slow': 'spin 8s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fade-in 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        'slide-up': { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        'fade-in': { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        html, body {
            height: 100%; width: 100%; overflow: hidden;
            background: linear-gradient(to bottom, #dbeafe 0%, #1e3a8a 50%, #020617 100%);
            color: #e2e8f0; -webkit-tap-highlight-color: transparent;
        }
        /* Safe Area for Mobile Notch */
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-panel {
            background: rgba(2, 6, 23, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }
        .bottom-sheet {
            background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(165, 243, 252, 0.3); box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            max-height: 85dvh; display: flex; flex-direction: column;
        }
        .sortable-ghost { opacity: 0.3; background: rgba(165, 243, 252, 0.1); }
        .sortable-drag { 
            cursor: grabbing; opacity: 1; background: rgba(30, 41, 59, 0.9); 
            border: 1px solid #a5f3fc; transform: scale(1.02); box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 50;
        }
        .text-glow { text-shadow: 0 0 10px rgba(165, 243, 252, 0.5); }
        .magic-input {
            width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.15);
            color: white; padding: 12px 16px; border-radius: 16px; font-size: 16px; outline: none; transition: all 0.3s;
        }
        .magic-input:focus { border-color: #a5f3fc; background: rgba(0, 0, 0, 0.5); box-shadow: 0 0 10px rgba(165, 243, 252, 0.2); }
        .scroller { overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; -ms-overflow-style: none; scrollbar-width: none; }
        .scroller::-webkit-scrollbar { display: none; }
        
        .magic-checkbox { appearance: none; width: 20px; height: 20px; border: 2px solid #a5f3fc; border-radius: 6px; position: relative; cursor: pointer; transition: all 0.2s; }
        .magic-checkbox:checked { background: #a5f3fc; }
        .magic-checkbox:checked::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; color: #0f172a; font-size: 12px; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .ice-card {
            background: rgba(242, 247, 250, 0.08); backdrop-filter: blur(20px);
            border: 1px solid rgba(167, 215, 255, 0.2);
            box-shadow: 0 0 15px rgba(167, 215, 255, 0.05);
        }
        .pie-chart {
            border-radius: 50%; position: relative; box-shadow: 0 0 20px rgba(167, 215, 255, 0.15);
        }
        .pie-chart::after {
            content: ""; position: absolute; inset: 25%; background: rgba(46, 51, 56, 0.9); border-radius: 50%;
        }
    </style>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
</head>

<body class="bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-cyan-950 to-slate-950 min-h-screen text-slate-200 overflow-x-hidden relative">    <div id="app" class="h-full w-full flex flex-col relative z-10">
        
        <div v-for="n in 10" :key="n" class="absolute rounded-full pointer-events-none animate-float opacity-30 bg-magic-ice blur-[2px]"
             :style="{ left: Math.random() * 100 + '%', top: Math.random() * 100 + '%', width: Math.random() * 4 + 'px', height: Math.random() * 4 + 'px', animationDuration: Math.random() * 10 + 15 + 's' }">
        </div>

        <transition name="fade" mode="out-in">
            <div v-if="isLoading" class="absolute inset-0 z-[100] flex flex-col items-center justify-center bg-magic-dark text-magic-ice">
                <div class="relative w-24 h-24 mb-6">
                    <div class="absolute inset-0 border-4 border-magic-ice/20 border-t-magic-ice rounded-full animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center animate-pulse"><i class="fa-solid fa-khanda text-4xl text-white"></i></div>
                </div>
                <p class="text-lg tracking-widest text-glow animate-pulse">騎士團集結中...</p>
            </div>
        </transition>

        <div v-else class="flex flex-col h-full w-full overflow-hidden">
            
            <header class="glass-panel px-3 py-2 flex justify-between items-center z-20 shrink-0 border-b-0 rounded-b-3xl mx-2 mt-2 pt-safe">
                <div class="flex items-center gap-2 overflow-hidden flex-1 mr-2">
                    <div class="w-10 h-10 rounded-full border border-magic-ice/40 flex items-center justify-center bg-black/30 relative shrink-0 animate-spin-slow shadow-[0_0_10px_rgba(165,243,252,0.3)]">
                        <div class="absolute inset-0 border border-white/10 rounded-full"></div>
                        <i :class="headerIcon" class="text-magic-ice text-base"></i>
                    </div>
                    <div class="flex flex-col justify-center min-w-0 flex-1">
                        <h1 class="text-sm font-bold text-white tracking-wider truncate text-glow">{{ headerTitle }}</h1>
                        <span class="text-[12px] text-cyan-200 font-cursive leading-none truncate">{{ headerSubtitle }}</span>
                    </div>
                </div>
                <div @click="toggleAI" class="flex items-center gap-1 shrink-0 active:scale-95 transition-transform cursor-pointer">
                    <span class="text-[10px] text-magic-ice/80 font-bold tracking-tight">召喚使魔</span>
                    <div class="w-8 h-8 rounded-full border border-magic-ice/30 flex items-center justify-center bg-white/5 active:bg-magic-ice/20 transition-colors">
                        <i class="fa-solid fa-cat text-white text-xs"></i>
                    </div>
                </div>
            </header>

            <main class="flex-1 flex flex-col min-h-0 mt-0 relative">
                
                <div v-if="currentTab === 'journal'" class="flex flex-col h-full min-h-0">
                    <section class="mt-1 px-4 shrink-0">
                        <div class="flex flex-wrap items-baseline gap-x-2 gap-y-0.5 mb-0.5 pl-4 pr-2">
                            <div class="flex items-center gap-2 shrink-0">
                                <i class="fa-solid fa-star-of-david text-[13px] text-cyan-200 animate-pulse"></i>
                                <span class="text-[13px] text-cyan-200 font-bold tracking-widest text-shadow-sm">星象廳觀測報告</span>
                            </div>
                            <a href="https://tenki.jp/forecast/6/29/6110/26100/10days.html" target="_blank" 
                               class="group cursor-pointer flex items-center gap-1 transition-all active:scale-95 opacity-90 hover:opacity-100">
                                <i class="fa-solid fa-fire text-[10px] text-amber-400 group-hover:scale-110 transition-transform drop-shadow-[0_0_5px_rgba(251,191,36,0.8)]"></i>
                                <span class="text-[10px] text-amber-300 font-bold italic border-b border-dashed border-amber-500/40 pb-0.5 group-hover:text-amber-100 group-hover:border-amber-200 transition-colors tracking-wide drop-shadow-md">
                                    妖族：京都可是咱們的地盤 愛看不看隨你
                                </span>
                            </a>
                        </div>

                        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1 snap-x">
                            <div v-for="w in weatherForecast" :key="w.date" 
                                 class="snap-start shrink-0 w-16 h-16 glass-panel rounded-xl flex flex-col items-center justify-center gap-0 relative overflow-hidden hover:bg-white/5 transition-colors border border-white/10 shadow-[0_4px_15px_rgba(0,0,0,0.3)]">
                                <span class="text-[10px] text-gray-300 font-sans tracking-wide font-bold leading-none mt-1">{{ w.date }}</span>
                                <i :class="w.icon" class="text-base my-0.5 drop-shadow-md filter"></i>
                                <div class="flex items-center gap-0.5 text-[10px] font-bold leading-none mb-1">
                                    <span class="text-blue-300">{{ w.low }}</span>
                                    <span class="text-gray-600">/</span>
                                    <span class="text-red-300">{{ w.high }}</span>
                                </div>
                                <div class="absolute -top-4 -right-4 w-6 h-6 bg-magic-ice/5 rounded-full blur-lg pointer-events-none"></div>
                            </div>
                        </div>
                    </section>

                    <div class="shrink-0 py-1.5 px-4 overflow-x-auto no-scrollbar flex gap-2 snap-x items-center">
                        <div v-for="(day, index) in days" :key="index" @click="selectDay(day.date)"
                            class="snap-start shrink-0 w-10 h-10 rounded-full border flex items-center justify-center transition-all duration-300 relative overflow-hidden group cursor-pointer"
                            :class="selectedDate === day.date ? 'bg-magic-ice/20 border-magic-ice shadow-[0_0_15px_rgba(165,243,252,0.4)] scale-110' : 'bg-black/30 border-white/10'">
                            <span class="text-sm font-bold font-mono leading-none" :class="selectedDate === day.date ? 'text-white' : 'text-gray-400'">{{ day.day }}</span>
                        </div>
                    </div>

                    <div class="px-5 py-0 text-left shrink-0 mb-1">
                        <h2 class="text-white drop-shadow-md flex items-center justify-start gap-2 flex-wrap">
                            <span class="font-cursive text-2xl text-magic-ice leading-none mt-0">{{ getChapterTitle(selectedDate) }}</span>
                            <span class="font-serif text-sm font-bold tracking-wide mt-1">{{ getChapterSubtitle(selectedDate) }}</span>
                        </h2>
                    </div>
                    <div class="flex-1 scroller px-4 pb-24">
                        <div v-if="currentEvents.length === 0" class="flex flex-col items-center justify-center py-16 text-gray-400">
                            <i class="fa-solid fa-scroll text-3xl mb-3 opacity-50"></i>
                            <p class="text-sm">尚未記載冒險...</p>
                        </div>
                        <div v-else id="itinerary-list">
                            <div v-for="event in currentEvents" :key="event.id" :data-id="event.id" @click="editEvent(event)"
                                class="relative pl-5 mb-4 group cursor-pointer active:scale-[0.99] transition-transform touch-manipulation">
                                <div class="absolute left-0 top-3 bottom-0 w-[2px] bg-gradient-to-b from-magic-ice/30 to-transparent"></div>
                                <div class="absolute -left-[5px] top-3 w-3 h-3 rounded-full bg-magic-dark border-2 border-magic-ice shadow-[0_0_8px_rgba(165,243,252,0.5)]"></div>
                                <div class="glass-panel rounded-2xl p-3 border-l-[3px]" :class="getCategoryColor(event.type)">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-[15px] font-mono text-magic-ice bg-black/40 px-1.5 py-0.5 rounded-md">{{ event.time }}</span>
                                        <i :class="getCategoryIcon(event.type)" class="text-gray-400 text-xs opacity-50"></i>
                                    </div>
                                    <h3 class="text-[1.25rem] font-bold text-white mb-1 leading-snug">{{ event.title }}</h3>
                                    <p class="text-[0.825rem] text-gray-300 leading-relaxed font-light whitespace-pre-line">{{ event.desc }}</p>
                                    <div v-if="event.link" class="mt-2">
                                        <a :href="event.link" target="_blank" @click.stop class="inline-flex items-center gap-2 text-[10px] bg-magic-ice/10 text-magic-ice px-3 py-1.5 rounded-xl border border-magic-ice/20 active:bg-magic-ice/30 transition-colors">
                                            <i class="fa-solid fa-link"></i> {{ event.linkText || '傳送門' }}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button @click="openAddModal" class="absolute bottom-24 right-5 w-12 h-12 rounded-full bg-gradient-to-br from-magic-ice to-cyan-600 text-magic-dark shadow-[0_8px_20px_rgba(165,243,252,0.4)] flex items-center justify-center text-xl active:scale-90 transition-transform z-30 border-2 border-white/20">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                
                <div v-else-if="currentTab === 'guild'" class="flex flex-col h-full min-h-0 font-serif">
                    <div class="px-4 py-2 shrink-0 flex gap-2">
                        <button v-for="sub in guildTabs" :key="sub.id" @click="guildSubTab = sub.id"
                            class="flex-1 py-2 rounded-xl border flex items-center justify-center gap-2 transition-all duration-300"
                            :class="guildSubTab === sub.id ? 'bg-magic-ice/20 border-magic-ice text-white shadow-[0_0_10px_rgba(165,243,252,0.2)]' : 'bg-black/20 border-white/10 text-gray-400'">
                            <i :class="sub.icon"></i>
                            <span class="text-xs font-bold tracking-widest">{{ sub.label }}</span>
                        </button>
                    </div>
                    <div v-if="guildSubTab === 'castle'" class="flex-1 scroller px-4 pb-24 animate-fade-in">
                        <div class="mb-4 text-center mt-2">
                            <h3 class="text-xl text-magic-ice font-cursive">The Demon King's Castles</h3>
                            <p class="text-[12px] text-gray-200 tracking-widest">歷史與權力的具現化</p>
                        </div>
                        <div v-for="castle in guildData.castles" :key="castle.name" class="glass-panel rounded-2xl p-4 mb-4 relative overflow-hidden group border border-white/10">
                            <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity">
                                <i class="fa-brands fa-fort-awesome text-6xl text-white"></i>
                            </div>
                            <h4 class="text-lg font-bold text-white mb-1 flex items-center gap-2"><i class="fa-solid fa-chess-rook text-magic-ice"></i> {{ castle.name }}</h4>
                            <div class="text-xs text-gray-300 leading-relaxed mb-3 font-light text-justify">{{ castle.desc }}</div>
                            <div class="bg-black/30 rounded-lg p-2 mb-3">
                                <div class="flex items-start gap-2 mb-1"><i class="fa-solid fa-circle-exclamation text-yellow-400 text-[10px] mt-0.5"></i><p class="text-[11px] text-gray-400">{{ castle.tips }}</p></div>
                                <div class="flex items-start gap-2"><i class="fa-solid fa-camera text-pink-400 text-[10px] mt-0.5"></i><p class="text-[11px] text-gray-400">{{ castle.photo }}</p></div>
                            </div>
                            <a :href="castle.map" target="_blank" class="block w-full py-2 bg-white/10 hover:bg-magic-ice/20 border border-white/20 rounded-xl text-center text-xs text-white transition-colors"><i class="fa-solid fa-location-arrow mr-1"></i> 開啟傳送門</a>
                        </div>
                    </div>
                    <div v-else-if="guildSubTab === 'labyrinth'" class="flex-1 flex flex-col min-h-0 animate-fade-in">
                        <div class="px-4 pb-4 pt-2 overflow-x-auto no-scrollbar flex gap-2 shrink-0 snap-x">
                            <button v-for="layer in guildData.labyrinth" :key="layer.id" @click="selectedLayer = layer.id"
                                class="snap-start relative px-3 py-2 rounded-xl border transition-all duration-300 flex flex-col items-center justify-center min-w-[76px] gap-1 group overflow-hidden shrink-0"
                                :class="selectedLayer === layer.id ? 'text-magic-dark scale-105' : 'bg-black/40 text-gray-400 hover:bg-black/60 hover:text-gray-200'"
                                :style="{
                                    borderColor: layer.themeColor,
                                    backgroundColor: selectedLayer === layer.id ? layer.themeColor : '',
                                    boxShadow: selectedLayer === layer.id ? `0 0 20px ${layer.themeColor}90` : '' 
                                }">
                                
                                <div v-if="selectedLayer !== layer.id" class="absolute inset-0 opacity-0 group-hover:opacity-20 transition-opacity duration-300" 
                                     :style="{ backgroundColor: layer.themeColor }"></div>

                                <span class="text-[10px] font-mono tracking-widest opacity-90 font-bold" 
                                      :class="selectedLayer === layer.id ? 'text-magic-dark' : 'text-gray-500'"
                                      :style="{ color: selectedLayer !== layer.id ? layer.themeColor : '' }">
                                    {{ layer.level }}
                                </span>

                                <div class="flex items-center gap-1.5">
                                    <i :class="layer.icon" class="text-xs transition-colors duration-300" 
                                       :style="{ color: selectedLayer === layer.id ? '#020617' : layer.themeColor }"></i>
                                    <span class="text-xs font-bold whitespace-nowrap">{{ layer.shortName }}</span>
                                </div>
                            </button>
                        </div>
                        <div class="flex-1 scroller px-4 pb-24 relative">
                            <div v-if="currentLayerData" class="animate-fade-in">
                                <div class="glass-panel rounded-2xl p-4 mb-4 border-l-4" :class="currentLayerData.colorClass">
                                    <h3 class="text-xl font-bold text-white mb-1">{{ currentLayerData.title }}</h3>
                                    <p class="text-xs text-magic-ice font-bold tracking-wider mb-2">{{ currentLayerData.rpgTitle }}</p>
                                    <p class="text-xs text-gray-300 leading-relaxed">{{ currentLayerData.desc }}</p>
                                </div>
                                <div class="space-y-4">
                                    <div v-for="(spot, idx) in currentLayerData.spots" :key="idx" class="bg-black/20 rounded-xl p-3 border border-white/5 relative">
                                        <div class="flex justify-between items-start mb-2">
                                            <h4 class="text-base font-bold text-white"><span class="mr-2 opacity-70">{{ idx + 1 }}.</span>{{ spot.name }}</h4>
                                            <a :href="spot.map" target="_blank" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center text-magic-ice hover:bg-white/20"><i class="fa-solid fa-location-arrow text-[10px]"></i></a>
                                        </div>
                                        <ul v-if="spot.items" class="space-y-1.5">
                                           <li v-for="item in spot.items" :key="item" class="text-sm text-gray-300 flex items-start gap-2 pl-1 border-l-2 border-white/10"> <span class="text-magic-ice mt-0.5 text-xs">◈</span> {{ item }}
                                        </ul>
                                        <p v-else class="text-[11px] text-gray-400 pl-1">{{ spot.desc }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else-if="guildSubTab === 'kyoto'" class="flex-1 flex flex-col min-h-0 animate-fade-in">
                        <div class="px-4 pb-2 flex gap-2 shrink-0 justify-center">
                            <button v-for="layer in guildData.kyoto" :key="layer.id" @click="selectedKyotoLayer = layer.id"
                                class="flex-1 py-1.5 rounded-full border text-[11px] font-bold whitespace-nowrap transition-all text-center"
                                :class="selectedKyotoLayer === layer.id ? 'bg-white text-magic-dark border-white' : 'bg-black/30 text-gray-400 border-white/10'">{{ layer.name }}</button>
                        </div>
                        <div class="flex-1 scroller px-4 pb-24 relative">
                            <div v-if="currentKyotoData" class="animate-fade-in">
                                <div class="glass-panel rounded-2xl p-4 mb-4 border-l-4" :class="currentKyotoData.colorClass">
                                    <h3 class="text-xl font-bold text-white mb-1">{{ currentKyotoData.title }}</h3>
                                    <p class="text-xs text-magic-ice font-bold tracking-wider mb-2">{{ currentKyotoData.rpgTitle }}</p>
                                    <div v-if="currentKyotoData.intro && currentKyotoData.intro.length" class="space-y-3 mt-3">
                                        <div v-for="(intro, i) in currentKyotoData.intro" :key="i" class="text-xs text-gray-300 leading-relaxed">
                                            <p class="font-bold text-white mb-1">▪ {{ intro.title }}</p>
                                            <p class="pl-2 border-l-2 border-white/10">{{ intro.desc }}</p>
                                        </div>
                                    </div>
                                    <p v-else class="text-xs text-gray-300 leading-relaxed">{{ currentKyotoData.desc }}</p>
                                </div>
                                <div v-if="currentKyotoData.zones" class="mb-6">
                                    <h4 class="text-sm font-bold text-magic-ice mb-3 border-b border-white/10 pb-1">主要地標</h4>
                                    <div v-for="(zone, idx) in currentKyotoData.zones" :key="idx" class="bg-black/20 rounded-xl p-3 border border-white/5 mb-3">
                                        <div class="flex justify-between items-start mb-1">
                                            <h5 class="text-sm font-bold text-white">{{ zone.name }}</h5>
                                            <span class="text-[10px] text-gray-400">{{ zone.title }}</span>
                                        </div>
                                        <div class="space-y-1">
                                            <p v-for="p in zone.subPoints" :key="p" class="text-[11px] text-gray-300 pl-2 border-l border-magic-ice/30">{{ p }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <h4 class="text-sm font-bold text-magic-ice mb-2 border-b border-white/10 pb-1">據點列表</h4>
                                    <div v-for="(spot, idx) in currentKyotoData.spots" :key="idx" class="bg-black/20 rounded-xl p-3 border border-white/5 relative">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <h4 class="text-sm font-bold text-white">{{ spot.name }}</h4>
                                                <span class="text-[12px] text-magic-ice block">{{ spot.rpgName }}</span>
                                            </div>
                                            <a :href="spot.map" target="_blank" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center text-magic-ice hover:bg-white/20"><i class="fa-solid fa-location-arrow text-[10px]"></i></a>
                                        </div>
                                        <p class="text-[13px] text-gray-300 leading-relaxed">{{ spot.desc }}</p>
                                        <p class="text-[11px] text-yellow-200/80 mt-1 pl-1 border-l-2 border-yellow-500/50" v-if="spot.bonus">Bonus: {{ spot.bonus }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentTab === 'supply'" class="flex flex-col h-full min-h-0 font-serif">
                    <div class="px-4 pt-3 pb-2 flex gap-3 overflow-x-auto no-scrollbar shrink-0">
                        <button v-for="tab in supplyTabs" :key="tab.id" @click="supplySubTab = tab.id"
                            class="relative flex-1 min-w-[140px] px-3 py-2 rounded-2xl border text-xs font-bold tracking-widest flex items-center justify-center gap-2 transition-all duration-300"
                            :class="supplySubTab === tab.id ? 'bg-white/10 border-white/70 text-white shadow-[0_0_18px_rgba(255,255,255,0.55)] -translate-y-0.5' : 'bg-black/30 border-white/10 text-gray-400'">
                            <div v-if="supplySubTab === tab.id" class="absolute inset-0 rounded-2xl pointer-events-none"><div class="absolute -inset-2 rounded-3xl bg-white/20 blur-xl opacity-80"></div></div>
                            <i :class="tab.icon" class="relative text-base"></i>
                            <span class="relative whitespace-nowrap">{{ tab.label }}</span>
                        </button>
                    </div>

                    <div class="px-5 pb-1 shrink-0 text-center">
                        <p v-if="supplySubTab === 'osaka'" class="text-[11px] text-gray-300 leading-relaxed">迷宮飯：大阪地下城的補給料理與出發前規劃的戰場糧食。</p>
                        <p v-else class="text-[11px] text-gray-300 leading-relaxed">靈脈礦石：妖都的礦石與護符素材，用來強化裝備與穩定靈脈。</p>
                    </div>

                    <div class="flex-1 scroller no-scrollbar px-4 pb-24 pt-2">
                        <div v-for="(item, idx) in currentSupplyList" :key="idx" 
                             class="glass-panel rounded-2xl p-4 border border-white/10 relative overflow-hidden mb-3 group">
                            
                            <div class="absolute -right-8 -top-8 w-24 h-24 rounded-full bg-magic-ice/10 blur-2xl opacity-60 group-hover:bg-magic-ice/20 transition-colors"></div>

                            <div class="relative flex justify-between items-start mb-2">
                                <div>
                                    <span class="inline-block px-2 py-0.5 rounded-md text-[10px] font-bold tracking-wider mb-1"
                                          :class="supplySubTab === 'osaka' ? 'bg-orange-500/20 text-orange-200 border border-orange-500/30' : 'bg-green-500/20 text-green-200 border border-green-500/30'">
                                    {{ item.tag }}
                                    </span>
                                    <h4 class="text-base font-bold text-white leading-tight shadow-black drop-shadow-md flex items-center gap-2">
                                        {{ item.name }}
                                    </h4>
                                </div>
                                <a :href="item.map" target="_blank" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-magic-ice border border-white/10 hover:bg-magic-ice hover:text-magic-dark transition-all active:scale-90 shrink-0">
                                    <i class="fa-solid fa-location-arrow text-xs"></i>
                                </a>
                            </div>

                            <p class="relative text-xs text-gray-300 leading-relaxed mb-3 border-l-2 border-white/10 pl-2">
                                {{ item.desc }}
                            </p>

                            <div v-if="supplySubTab === 'osaka'" class="relative flex flex-wrap items-center gap-3 bg-black/20 rounded-xl p-2 border border-white/5">
                                <div class="flex gap-0.5 text-[10px]">
                                    <i v-for="n in 5" :key="n" class="fa-solid fa-star" :class="n <= item.rating ? 'text-yellow-400' : 'text-gray-600'"></i>
                                </div>
                                <div class="w-[1px] h-3 bg-white/10"></div>
                                <div class="flex items-center gap-3 text-[10px] text-gray-400 font-mono">
                                    <span class="flex items-center gap-1" v-if="item.hours"><i class="fa-regular fa-clock text-magic-ice/70"></i> {{ item.hours }}</span>
                                    <span class="flex items-center gap-1" v-if="item.price"><i class="fa-solid fa-yen-sign text-yellow-200/70"></i> {{ item.price }}</span>
                                </div>
                            </div>

                            <div v-if="supplySubTab === 'kyoto' && item.items" class="relative mt-2">
                                <h5 class="text-[10px] text-magic-ice/80 mb-1 font-bold flex items-center gap-1">
                                    <i class="fa-solid fa-gem"></i> 推薦戰利品
                                </h5>
                                <div class="flex flex-wrap gap-2">
                                    <span v-for="good in item.items" :key="good" 
                                          class="px-2 py-1 rounded-lg bg-white/5 border border-white/10 text-[11px] text-gray-200 flex items-center gap-1">
                                    <i class="fa-solid fa-caret-right text-green-400/80 text-[10px]"></i> {{ good }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="h-8"></div>
                    </div>
                </div>
                <div v-else-if="currentTab === 'coins'" class="flex flex-col h-full min-h-0 font-serif">
                    
                    <div class="px-4 py-2 shrink-0 flex gap-2">
                        <button v-for="sub in coinTabs" :key="sub.id" @click="coinSubTab = sub.id"
                            class="flex-1 py-1.5 rounded-lg border flex items-center justify-center gap-2 transition-all duration-300 relative overflow-hidden"
                            :class="coinSubTab === sub.id ? 'bg-magic-blue/10 border-magic-blue text-white shadow-[0_0_10px_rgba(167,215,255,0.2)]' : 'bg-black/20 border-white/5 text-gray-400'">
                            <i :class="sub.icon" class="text-xs"></i>
                            <span class="text-xs font-bold tracking-widest">{{ sub.label }}</span>
                            <div v-if="coinSubTab === sub.id" class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent w-full animate-slide-up opacity-30"></div>
                        </button>
                    </div>

                    <div v-if="coinSubTab === 'ledger'" class="flex-1 flex flex-col min-h-0 animate-fade-in">
                        
                        <div class="shrink-0 px-4 py-1 overflow-x-auto no-scrollbar flex gap-3 snap-x mb-1">
                            <button v-for="chap in chapters" :key="chap.id" @click="selectedChapter = chap.id"
                                class="snap-start shrink-0 px-4 py-2 rounded-xl border transition-all duration-300 relative group flex flex-col items-center min-w-[80px]"
                                :class="selectedChapter === chap.id ? 'bg-magic-blue/10 border-magic-blue' : 'bg-black/20 border-white/5'">
                                <span class="text-[10px] tracking-widest mb-0.5" :class="selectedChapter === chap.id ? 'text-magic-blue' : 'text-gray-500'">{{ chap.label }}</span>
                                <span class="text-xs font-bold font-mono" :class="selectedChapter === chap.id ? 'text-white text-glow' : 'text-gray-400'">{{ chap.dateShort }}</span>
                                
                                <div v-if="selectedChapter === chap.id" class="absolute -bottom-1 w-8 h-0.5 bg-magic-blue blur-[2px] rounded-full"></div>
                            </button>
                        </div>

                        <div class="shrink-0 px-4 pt-2 mb-2 relative z-20">
                            <div class="glass-panel rounded-2xl p-5 shadow-lg relative overflow-hidden">
                                <div class="absolute -right-10 -top-10 w-40 h-40 bg-magic-blue/10 rounded-full blur-3xl pointer-events-none"></div>

                                <div class="flex items-start justify-between relative z-10">
                                    <div>
                                        <p class="text-[10px] tracking-[0.1em] text-magic-blue/80 mb-1 font-bold">
                                            {{ currentChapterInfo.fullTitle }}
                                        </p>
                                        <p class="text-[11px] tracking-[0.25em] text-magic-silver/60">
                                            今日花費
                                        </p>
                                        <p class="mt-1 text-3xl font-semibold text-white font-mono drop-shadow-[0_0_8px_rgba(167,215,255,0.3)]">
                                            {{ formatMoney(todayTotalTWD) }}
                                            <span class="text-sm font-medium text-magic-blue ml-1 font-serif">
                                                加隆
                                            </span>
                                        </p>
                                        <p class="text-[11px] text-gray-400 font-mono mt-1">
                                            ≈ ¥ {{ formatMoney(todayTotalYen) }} 
                                            <span class="mx-1 text-gray-600">|</span> 
                                            累計: {{ formatMoney(grandTotalTWD) }} G♢
                                        </p>
                                    </div>

                                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-xl bg-magic-night/60 border border-magic-blue/30 shadow-inner">
                                            <i class="fa-solid fa-pen-nib text-magic-blue text-xs"></i>
                                            <span class="text-[10px] text-magic-silver tracking-wide">
                                                記帳中
                                            </span>
                                    </div>
                                </div>

                                <div class="mt-4 mb-3 h-px bg-gradient-to-r from-transparent via-magic-blue/40 to-transparent"></div>

                                <div class="text-center">
                                    <p class="text-[10px] text-magic-silver/80 italic leading-relaxed">
                                        <i class="fa-solid fa-wand-magic-sparkles mr-1 text-magic-blue"></i> 
                                        {{ magicSummaryQuote }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 scroller px-4 pb-24 relative z-10">
                            <div v-if="currentChapterExpenses.length === 0" class="rounded-xl border border-dashed border-magic-blue/30 bg-black/20 px-4 py-8 flex items-center gap-4 mt-2">
                                <div class="flex h-12 w-12 items-center justify-center rounded-full bg-magic-blue/10 border border-magic-blue/30 animate-pulse-slow">
                                    <i class="fa-solid fa-moon text-magic-blue text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-white font-bold">
                                        本章節尚未留下任何消費魔法痕跡
                                    </p>
                                    <p class="mt-1 text-xs text-magic-silver/70 leading-relaxed">
                                        輕點右下角 <i class="fa-solid fa-plus text-[10px] bg-magic-blue text-magic-night rounded-full w-3 h-3 inline-flex items-center justify-center mx-0.5"></i>
                                        開始記錄你的第一筆支出吧。
                                    </p>
                                </div>
                            </div>

                            <div v-else class="space-y-2 mt-1">
                                <div v-for="item in currentChapterExpenses" :key="item.id" @click="editExpense(item)"
                                    class="glass-panel rounded-xl flex items-center justify-between px-4 py-3 cursor-pointer active:scale-[0.99] transition-all hover:bg-white/5 border border-white/10 group">
                                    
                                    <div class="flex items-center gap-3">
                                        <div class="w-9 h-9 rounded-full bg-black/40 flex items-center justify-center text-magic-blue border border-white/10 group-hover:border-magic-blue/40 transition-colors shadow-inner">
                                            <i :class="getExpenseIcon(item.type)" class="text-xs"></i>
                                        </div>
                                        <div>
                                            <p class="text-sm text-white font-bold leading-none mb-1.5">
                                                {{ item.title || '未命名支出' }}
                                            </p>
                                            <div class="flex items-center gap-2">
                                                <span class="text-[10px] text-magic-blue/70 bg-magic-blue/10 px-1.5 py-0.5 rounded">
                                                    {{ getExpenseLabel(item.type).split('(')[0] }}
                                                </span>
                                                <i :class="getPaymentIcon(item.payment)" class="text-[10px] text-gray-500"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="text-right">
                                        <p class="text-sm font-bold text-amber-200 font-mono">
                                            {{ formatMoney(item.twd) }} <span class="text-[10px] text-amber-200/70">G♢</span>
                                        </p>
                                        <p class="text-[10px] text-gray-500 font-mono mt-0.5">
                                            ¥ {{ formatMoney(item.yen) }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button @click="openExpenseModal('add')" class="absolute bottom-24 right-5 w-14 h-14 rounded-full bg-magic-night border border-magic-blue text-magic-blue shadow-[0_0_20px_rgba(167,215,255,0.3)] flex items-center justify-center text-2xl active:scale-90 transition-transform z-30 group overflow-hidden"> <div class="absolute inset-0 bg-magic-blue/20 rounded-full scale-0 group-active:scale-150 transition-transform duration-300"></div> <i class="fa-solid fa-plus relative z-10"></i> </button>
                    </div>

                    <div v-else-if="coinSubTab === 'stats'" class="flex-1 scroller px-4 pb-24 pt-2 animate-fade-in">
                        
                        <div class="ice-card rounded-2xl p-5 mb-4 flex flex-col items-center">
                            <h3 class="text-sm font-bold text-white mb-4 w-full flex items-center gap-2">
                                <i class="fa-solid fa-chart-pie text-magic-blue"></i> 加隆屬性分布
                            </h3>
                            <div class="relative w-48 h-48 mb-4">
                                <div class="w-full h-full pie-chart" :style="{ background: pieChartGradient }"></div>
                                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10">
                                    <span class="text-[10px] text-gray-400">總消耗</span>
                                    <span class="text-lg font-bold text-white font-mono">{{ formatMoney(grandTotalTWD) }}</span>
                                    <span class="text-[10px] text-magic-blue">G♢</span>
                                </div>
                            </div>
                            <div class="w-full grid grid-cols-2 gap-2">
                                <div v-for="cat in pieChartData" :key="cat.type" class="flex items-center gap-2 text-[11px]">
                                    <div class="w-2 h-2 rounded-full shadow-[0_0_5px]" :style="{ background: cat.color, boxShadow: `0 0 5px ${cat.color}` }"></div>
                                    <span class="text-gray-300 flex-1 truncate">{{ cat.label.split('(')[0] }}</span>
                                    <span class="text-white font-mono">{{ Math.round(cat.percent) }}%</span>
                                </div>
                            </div>
                        </div>

                        <div class="ice-card rounded-2xl p-5 mb-4">
                            <h3 class="text-sm font-bold text-white mb-4 w-full flex items-center gap-2">
                                <i class="fa-solid fa-wave-square text-magic-blue"></i> 加隆流動曲線
                            </h3>
                            <div class="h-40 w-full relative flex items-end justify-between px-2">
                                <svg class="absolute inset-0 w-full h-full" overflow="visible">
                                    <defs>
                                        <linearGradient id="lineGradient" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="0%" stop-color="#A7D7FF" stop-opacity="0.5"/>
                                            <stop offset="100%" stop-color="#A7D7FF" stop-opacity="0"/>
                                        </linearGradient>
                                    </defs>
                                    <path :d="lineChartAreaPath" fill="url(#lineGradient)" stroke="none" />
                                    <path :d="lineChartPath" fill="none" stroke="#A7D7FF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="drop-shadow-[0_0_5px_rgba(167,215,255,0.8)]"/>
                                    <circle v-for="dot in lineChartDots" :key="dot.x" :cx="dot.x" :cy="dot.y" r="3" fill="#2E3338" stroke="#A7D7FF" stroke-width="2" />
                                </svg>
                            </div>
                            <div class="flex justify-between mt-2 px-1">
                                <span v-for="chap in chapters" :key="chap.id" class="text-[9px] text-gray-500 font-mono">{{ chap.label.replace('第','').replace('章','') }}</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 mb-3 mt-6 px-1">
                            <i class="fa-solid fa-calendar-days text-magic-blue"></i>
                            <h3 class="text-sm font-bold text-white tracking-widest">章節花費摘要</h3>
                        </div>

                        <div class="space-y-3">
                             <div v-for="chap in chapters" :key="chap.id" class="ice-card rounded-xl p-3 border-l-2 border-l-magic-blue/50">
                                 <div class="flex justify-between items-center mb-1">
                                     <span class="text-xs font-bold text-magic-blue">{{ chap.fullTitle }}</span>
                                     <span class="text-xs text-white font-mono">{{ formatMoney(getChapterTotal(chap.id)) }} G♢</span>
                                 </div>
                                 <div class="flex justify-between items-center text-[10px] text-gray-400">
                                     <span class="italic opacity-80">{{ getChapterSummarySentence(chap.id) }}</span>
                                 </div>
                             </div>
                        </div>
                    </div>

                    <div v-else-if="coinSubTab === 'settings'" class="flex-1 px-4 pt-4 animate-fade-in">
                        <div class="ice-card rounded-2xl p-6 text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-magic-blue to-transparent opacity-50"></div>
                            <i class="fa-solid fa-scale-balanced text-3xl text-magic-blue mb-4 drop-shadow-[0_0_10px_rgba(167,215,255,0.5)]"></i>
                            <h3 class="text-lg font-bold text-white mb-1">加隆匯率設定</h3>
                            <p class="text-xs text-gray-400 mb-6">1 G♢ (加隆) = {{ exchangeRate }} ¥ (日幣)</p>
                            
                            <div class="relative max-w-[200px] mx-auto mb-4">
                                <label class="block text-[10px] text-magic-blue text-left mb-1 ml-1">今日匯率 (TWD/JPY)</label>
                                <input type="number" step="0.0001" v-model="exchangeRate" class="magic-input text-center font-mono text-xl">
                                <div class="absolute right-3 top-8 text-xs text-gray-500">Rate</div>
                            </div>

                            <p class="text-[10px] text-magic-silver">
                                <i class="fa-regular fa-clock mr-1"></i> 加隆匯率更新於 {{ lastRateUpdate }}
                            </p>
                        </div>

                    <div class="mt-6 text-center pb-8">
                        <button @click="resetData" class="text-[11px] text-red-400/80 border border-red-500/30 px-4 py-2 rounded-xl hover:bg-red-500/10 active:scale-95 transition-all">
                            <i class="fa-solid fa-trash-can mr-2"></i>銷毀紀錄 (重置)
                        </button>
                        <p class="text-[9px] text-gray-600 mt-2">若資料異常或想重新開始，請點擊此處</p>
                    </div>

                </div>
              </div>    
                <div v-else-if="currentTab === 'bag'" class="flex flex-col h-full min-h-0 font-serif">
                    <div class="flex-1 scroller px-4 pb-24 space-y-5 animate-fade-in pt-3">
                        
                        <div class="glass-panel rounded-2xl p-4 border border-white/10">
                            <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2"><i class="fa-solid fa-plane-departure text-magic-ice"></i> 龍鱗飛艇航行日誌</h3>
                            <div class="mb-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-0.5 rounded-md bg-blue-900/50 border border-blue-400/30 text-[10px] text-blue-200 font-bold">主隊</span>
                                    <span class="h-[1px] flex-1 bg-white/10"></span>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div class="bg-black/20 p-2 rounded-lg border border-white/5">
                                        <div class="flex justify-between items-center mb-1"><span class="text-gray-400 text-[10px]">啟程 12/14</span><span class="font-mono text-magic-ice">CI156</span></div>
                                        <div class="flex justify-between items-end">
                                            <div><div class="font-bold text-white text-sm">08:05</div><div class="text-[10px] text-gray-500">TPE T2</div></div>
                                            <i class="fa-solid fa-arrow-right text-gray-600 text-[10px] mb-1"></i>
                                            <div class="text-right"><div class="font-bold text-white text-sm">11:35</div><div class="text-[10px] text-gray-500">KIX T1</div></div>
                                        </div>
                                    </div>
                                    <div class="bg-black/20 p-2 rounded-lg border border-white/5">
                                        <div class="flex justify-between items-center mb-1"><span class="text-gray-400 text-[10px]">回程 12/20</span><span class="font-mono text-magic-ice">CI173</span></div>
                                        <div class="flex justify-between items-end">
                                            <div><div class="font-bold text-white text-sm">19:00</div><div class="text-[10px] text-gray-500">KIX T1</div></div>
                                            <i class="fa-solid fa-arrow-right text-gray-600 text-[10px] mb-1"></i>
                                            <div class="text-right"><div class="font-bold text-white text-sm">21:15</div><div class="text-[10px] text-gray-500">TPE T2</div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-0.5 rounded-md bg-purple-900/50 border border-purple-400/30 text-[10px] text-purple-200 font-bold">分隊</span>
                                    <span class="h-[1px] flex-1 bg-white/10"></span>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div class="bg-black/20 p-2 rounded-lg border border-white/5">
                                        <div class="flex justify-between items-center mb-1"><span class="text-gray-400 text-[10px]">啟程 12/17</span><span class="font-mono text-purple-300">GK50</span></div>
                                        <div class="flex justify-between items-end">
                                            <div><div class="font-bold text-white text-sm">02:30</div><div class="text-[10px] text-gray-500">TPE T1</div></div>
                                            <i class="fa-solid fa-arrow-right text-gray-600 text-[10px] mb-1"></i>
                                            <div class="text-right"><div class="font-bold text-white text-sm">06:00</div><div class="text-[10px] text-gray-500">KIX T1</div></div>
                                        </div>
                                    </div>
                                    <div class="bg-black/20 p-2 rounded-lg border border-white/5">
                                        <div class="flex justify-between items-center mb-1"><span class="text-gray-400 text-[10px]">回程 12/20</span><span class="font-mono text-purple-300">MM027</span></div>
                                        <div class="flex justify-between items-end">
                                            <div><div class="font-bold text-white text-sm">15:25</div><div class="text-[10px] text-gray-500">KIX T2</div></div>
                                            <i class="fa-solid fa-arrow-right text-gray-600 text-[10px] mb-1"></i>
                                            <div class="text-right"><div class="font-bold text-white text-sm">17:55</div><div class="text-[10px] text-gray-500">TPE T1</div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-panel rounded-2xl p-4 border border-white/10">
                            <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check text-magic-ice"></i> 出發檢核術式</h3>
                            <div class="space-y-2">
                                <label v-for="(item, idx) in checklistItems" :key="idx" 
                                    class="flex items-center gap-3 p-3 bg-black/20 rounded-xl cursor-pointer hover:bg-black/30 transition-colors border border-white/5 active:scale-[0.98]">
                                    <input type="checkbox" v-model="item.checked" class="magic-checkbox shrink-0">
                                    <span class="text-sm transition-all duration-300 select-none" 
                                          :class="item.checked ? 'text-gray-600 line-through decoration-magic-ice decoration-2' : 'text-gray-200'">
                                    {{ item.label }}
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div class="glass-panel rounded-2xl p-4 border border-white/10 relative overflow-hidden">
                            <div class="absolute -right-6 -bottom-6 text-8xl text-indigo-500/10"><i class="fa-solid fa-hotel"></i></div>
                            <div class="flex justify-between items-start mb-2 relative">
                                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="fa-solid fa-bed text-magic-ice"></i> 隱者之灯</h3>
                                <a href="https://www.hotelforza.jp/kyotoshijo/" target="_blank" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-magic-ice hover:bg-white/20 active:scale-95 transition-all"><i class="fa-solid fa-link"></i></a>
                            </div>
                            <p class="text-sm font-bold text-white mb-1">ホテルフォルツァ京都四条河原町</p>
                            <p class="text-xs text-gray-300 mb-2 font-mono">TEL 075-254-8251</p>
                            <p class="text-xs text-gray-400 leading-relaxed border-t border-white/10 pt-2">〒600-8005 京都府京都市下京区四条通麩屋町西入立売東町25-1</p>
                            <a href="https://maps.app.goo.gl/9Z1jZ1jZ1jZ1jZ1j" target="_blank" class="inline-flex items-center gap-1.5 text-[10px] text-magic-ice mt-2 bg-magic-ice/10 px-2 py-1 rounded-lg"><i class="fa-solid fa-map-location-dot"></i> 開啟地圖</a>
                        </div>

                        <div class="glass-panel rounded-2xl p-4 border border-white/10">
                            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-shield-heart text-magic-ice"></i> 緊急後援</h3>
                            
                            <div class="mb-4 pb-4 border-b border-white/10">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-sm font-bold text-blue-200">守護者的召喚 (大阪辦事處)</h4>
                                    <a href="https://www.roc-taiwan.org/jposa/cat/64.html" target="_blank" class="text-magic-ice text-xs bg-white/5 px-2 py-1 rounded-lg border border-white/10"><i class="fa-solid fa-link mr-1"></i>官網</a>
                                </div>
                                <div class="space-y-2">
                                    <a href="tel:+81662278623" class="flex items-center gap-3 p-2 bg-blue-900/20 rounded-lg border border-blue-500/20 active:bg-blue-900/40">
                                        <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-300"><i class="fa-solid fa-phone"></i></div>
                                        <div><div class="text-xs text-gray-400">緊急聯絡</div><div class="text-sm font-mono text-white">06-6227-8623</div></div>
                                    </a>
                                    <div class="flex items-start gap-3 p-2">
                                        <div class="w-8 h-8 rounded-full bg-gray-700/30 flex items-center justify-center text-gray-400 shrink-0"><i class="fa-solid fa-location-dot"></i></div>
                                        <p class="text-xs text-gray-400 pt-1">大阪市北区中之島二丁目三番一八号 17F/19F</p>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h4 class="text-sm font-bold text-red-200 mb-2">祭司的加護 (醫療/協助)</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <a href="https://reurl.cc/vKvDRN" target="_blank" class="flex items-center justify-between p-3 bg-red-900/10 rounded-xl border border-red-500/10 active:bg-red-900/20">
                                        <span class="text-xs text-red-100"><i class="fa-solid fa-truck-medical mr-2"></i>中文醫療服務清單</span>
                                        <i class="fa-solid fa-arrow-up-right-from-square text-[10px] text-red-300"></i>
                                    </a>
                                    <a href="tel:05038162787" class="flex items-center justify-between p-3 bg-red-900/10 rounded-xl border border-red-500/10 active:bg-red-900/20">
                                        <div><div class="text-xs text-red-100"><i class="fa-solid fa-headset mr-2"></i>JNTO 訪日旅客呼叫中心</div><div class="text-[10px] text-red-300/70 ml-6">24hr 中文應對</div></div>
                                        <span class="font-mono text-xs text-red-200">Call</span>
                                    </a>
                                    <div class="p-3 bg-red-900/10 rounded-xl border border-red-500/10">
                                        <div class="text-xs text-red-100 mb-1"><i class="fa-solid fa-star-of-life mr-2"></i>國際 SOS (台北24hr)</div>
                                        <div class="pl-6 space-y-1">
                                            <a href="tel:+886225232220" class="block text-xs font-mono text-red-300">+886-2-2523-2220</a>
                                            <a href="tel:+886912909677" class="block text-xs font-mono text-red-300">+886-912-909-677 (郭先生)</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h4 class="text-sm font-bold text-green-200 mb-2">公會物資轉運所 (郵務/寄送)</h4>
                                <a href="https://www.post.japanpost.jp/int/index_cn.html" target="_blank" class="flex items-center justify-between p-3 bg-green-900/10 rounded-xl border border-green-500/10 active:bg-green-900/20 group">
                                    <div>
                                        <div class="text-xs text-green-100 font-bold"><i class="fa-solid fa-box-open mr-2"></i>日本郵便局 (Japan Post)</div>
                                        <div class="text-[10px] text-green-300/70 ml-6 mt-0.5">將戰利品傳送回國</div>
                                    </div>
                                    <i class="fa-solid fa-arrow-up-right-from-square text-[10px] text-green-300 group-hover:translate-x-0.5 transition-transform"></i>
                                </a>
                            </div>

                        </div>

                        <div class="glass-panel rounded-2xl p-4 border border-white/10 mb-8">
                            <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2"><i class="fa-solid fa-feather-pointed text-magic-ice"></i> 觀測日誌</h3>
                            <textarea v-model="bagMemo" class="w-full h-40 bg-transparent border border-white/10 rounded-xl p-3 text-sm text-gray-200 placeholder-gray-600 focus:border-magic-ice/50 focus:bg-black/20 outline-none resize-none leading-relaxed font-serif" placeholder="在此記錄旅途中的隨筆、帳務或靈感..."></textarea>
                        </div>
                    </div>
                </div>

                <div v-else class="flex-1 flex items-center justify-center text-gray-500">
                    <p class="text-sm">功能開發中</p>
                </div>
            </main>
            
            <nav class="fixed bottom-0 left-0 right-0 glass-panel border-t border-t-white/15 border-x-0 border-b-0 rounded-t-3xl flex justify-between px-6 items-center pt-1 pb-safe z-40 bg-[#0f172a]/95 backdrop-blur-xl h-[55px]">
                <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                    class="relative flex flex-col items-center justify-center w-12 gap-0 transition-all duration-300 group"
                    :class="currentTab === tab.id ? (tab.id === 'coins' ? 'text-magic-blue' : 'text-magic-ice') : 'text-gray-500 hover:text-gray-300'">
                    <div class="relative transition-all duration-300" :class="currentTab === tab.id ? '-translate-y-0.5' : ''">
                        <i :class="tab.icon" class="text-[20px] mb-0.5"></i>
                        <div v-if="currentTab === tab.id" class="absolute -inset-2 bg-magic-ice/20 blur-lg rounded-full"></div>
                    </div>
                    <span class="text-[9px] font-medium tracking-wide transition-colors duration-300 leading-none scale-90 origin-top" :class="currentTab === tab.id ? 'text-white' : 'text-gray-500 group-hover:text-gray-400'">{{ tab.label }}</span>
                    <div v-if="currentTab === tab.id" class="absolute -bottom-1 w-1 h-1 bg-magic-ice rounded-full shadow-[0_0_8px_#a5f3fc]"></div>
                </button>
             </nav>

            <transition enter-active-class="transition duration-300 ease-out" enter-from-class="translate-y-full opacity-0" enter-to-class="translate-y-0 opacity-100" leave-active-class="transition duration-200 ease-in" leave-from-class="translate-y-0 opacity-100" leave-to-class="translate-y-full opacity-0">
                <div v-if="showChatModal" class="fixed inset-0 z-[80] flex flex-col justify-end">
                    <div @click="toggleAI" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
                    <div class="bottom-sheet w-full rounded-t-[2rem] p-5 pt-4 relative z-10 animate-slide-up bg-slate-950/95 border-t border-magic-ice/40 flex flex-col h-[70vh]">
                        <div class="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mb-4 opacity-40"></div>
                        <div class="flex items-center justify-between mb-4 border-b border-white/10 pb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-full bg-black/60 border border-magic-ice/50 flex items-center justify-center shadow-[0_0_12px_rgba(165,243,252,0.5)]">
                                    <i class="fa-solid fa-cat text-magic-ice text-lg"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-magic-ice/70 tracking-[0.2em]">FAMILIAR CHAT</p>
                                    <p class="text-sm text-white font-bold">貓貓使魔．尼洛</p>
                                </div>
                            </div>
                            <button @click="toggleAI" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 active:bg-white/10">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        <div class="mb-3">
                            <label class="text-[11px] text-magic-ice/80 mb-1 ml-1 block flex items-center gap-1">
                                <i class="fa-solid fa-key text-[10px]"></i> 契約之鑰（Google API Key）
                            </label>
                            <input v-model="apiKey" type="password" placeholder="貼上妳的 Google API Key，貓貓才有法力喵" class="magic-input text-xs font-mono" />
                            <p class="mt-1 text-[10px] text-gray-500 leading-snug">
                                <span class="text-magic-ice/80">提示：</span>此 Key 不會被儲存，只在本頁執行時暫時使用。
                            </p>
                        </div>
                        <div class="flex-1 chat-scroll overflow-y-auto space-y-3 rounded-2xl bg-black/40 border border-white/10 p-3 mt-2">
                            <div v-for="(msg, idx) in chatHistory" :key="idx" class="flex" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                                <div v-if="msg.role === 'model'" class="max-w-[80%] bg-slate-800/90 border border-magic-ice/40 rounded-2xl rounded-tl-sm px-3 py-2 text-[13px] text-gray-100 shadow-[0_0_10px_rgba(165,243,252,0.25)]">
                                    {{ msg.text }}
                                </div>
                                <div v-else class="max-w-[80%] bg-magic-ice text-magic-dark rounded-2xl rounded-tr-sm px-3 py-2 text-[13px] font-medium shadow-[0_0_10px_rgba(165,243,252,0.4)]">
                                    {{ msg.text }}
                                </div>
                            </div>
                            <div v-if="isSummoning" class="flex justify-start">
                                <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-slate-800/90 rounded-2xl border border-magic-ice/30 text-[11px] text-magic-ice">
                                    <span class="w-2 h-2 rounded-full bg-magic-ice animate-ping"></span>
                                    <span>貓貓正在翻找地圖與古卷喵…</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex items-center gap-2 pt-2 border-t border-white/10">
                            <input v-model="chatInput" @keyup.enter="summonFamiliar" type="text" placeholder="輸入想問的大阪／京都問題，或請貓貓幫忙翻譯..." class="magic-input flex-1 text-sm" />
                            <button @click="summonFamiliar" :disabled="isSummoning" class="w-10 h-10 rounded-full bg-magic-ice text-magic-dark flex items-center justify-center active:scale-95 disabled:opacity-60">
                                <i class="fa-solid" :class="isSummoning ? 'fa-circle-notch fa-spin' : 'fa-paper-plane'"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <transition enter-active-class="transition duration-300 ease-out" enter-from-class="translate-y-full opacity-0" enter-to-class="translate-y-0 opacity-100" leave-active-class="transition duration-200 ease-in" leave-from-class="translate-y-0 opacity-100" leave-to-class="translate-y-full opacity-0">
                <div v-if="isModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="closeModal"></div>
                    <div class="glass-panel w-full max-w-sm rounded-2xl p-5 relative z-10 animate-slide-up border border-magic-ice/30 shadow-[0_0_30px_rgba(165,243,252,0.15)]">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-pen-nib text-magic-ice"></i>
                            {{ modalMode === 'add' ? '撰寫新冒險' : '修訂冒險記錄' }}
                        </h3>
                        <div class="space-y-3">
                            <div><label class="text-xs text-magic-ice/70 mb-1 block">時間 (Time)</label><input v-model="editingEvent.time" type="time" class="magic-input"></div>
                            <div><label class="text-xs text-magic-ice/70 mb-1 block">標題 (Title)</label><input v-model="editingEvent.title" type="text" class="magic-input" placeholder="例如：攻略大阪城"></div>
                            <div>
                                <label class="text-xs text-magic-ice/70 mb-1 block">類別 (Type)</label>
                                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                    <button v-for="type in eventTypes" :key="type.val" @click="editingEvent.type = type.val" class="px-3 py-1.5 rounded-lg border text-xs shrink-0 transition-all" :class="editingEvent.type === type.val ? 'bg-magic-ice text-magic-dark border-magic-ice font-bold' : 'bg-transparent text-gray-400 border-white/20'"><i :class="type.icon" class="mr-1"></i>{{ type.label }}</button>
                                </div>
                            </div>
                            <div><label class="text-xs text-magic-ice/70 mb-1 block">內容 (Description)</label><textarea v-model="editingEvent.desc" rows="3" class="magic-input resize-none" placeholder="記錄細節..."></textarea></div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="text-xs text-magic-ice/70 mb-1 block">連結 (Link)</label><input v-model="editingEvent.link" type="text" class="magic-input text-xs" placeholder="URL"></div>
                                <div><label class="text-xs text-magic-ice/70 mb-1 block">連結文字 (Text)</label><input v-model="editingEvent.linkText" type="text" class="magic-input text-xs" placeholder="顯示文字"></div>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button v-if="modalMode === 'edit'" @click="handleDelete" class="flex-1 py-2.5 rounded-xl border border-red-500/50 text-red-400 hover:bg-red-500/10 transition-colors text-sm font-bold">{{ confirmDelete ? '確定刪除？' : '刪除' }}</button>
                            <button @click="saveEvent" class="flex-[2] py-2.5 rounded-xl bg-magic-ice text-magic-dark font-bold hover:bg-white transition-colors shadow-[0_0_15px_rgba(165,243,252,0.4)] text-sm">儲存紀錄</button>
                        </div>
                        <button @click="closeModal" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-times text-lg"></i></button>
                    </div>
                </div>
            </transition>

            <transition enter-active-class="transition duration-300 ease-out" enter-from-class="translate-y-full opacity-0" enter-to-class="translate-y-0 opacity-100" leave-active-class="transition duration-200 ease-in" leave-from-class="translate-y-0 opacity-100" leave-to-class="translate-y-full opacity-0">
                <div v-if="isExpenseModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="closeExpenseModal"></div>
                    <div class="glass-panel w-full max-w-sm rounded-2xl p-5 relative z-10 animate-slide-up border border-magic-blue/30 shadow-[0_0_30px_rgba(167,215,255,0.15)]">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-coins text-magic-blue"></i>
                            {{ expenseModalMode === 'add' ? '消費紀錄' : '修正帳目' }}
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-magic-blue/70 mb-1 block">金額 (JPY)</label>
                                <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">¥</span><input v-model.number="editingExpense.yen" type="number" class="magic-input pl-8 font-mono text-lg text-yellow-200" placeholder="0"></div>
                                <p class="text-right text-[10px] text-gray-400 mt-1">≈ {{ calculatedTWD }} TWD</p>
                            </div>
                            <div><label class="text-xs text-magic-blue/70 mb-1 block">項目名稱 (Item)</label><input v-model="editingExpense.title" type="text" class="magic-input" placeholder="例如：章魚燒"></div>
                            <div>
                                <label class="text-xs text-magic-blue/70 mb-1 block">消費類別 (Category)</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <button v-for="cat in expenseCategories" :key="cat.val" @click="editingExpense.type = cat.val" class="flex flex-col items-center justify-center p-2 rounded-lg border transition-all aspect-square" :class="editingExpense.type === cat.val ? 'bg-magic-blue/20 border-magic-blue text-white' : 'bg-transparent border-white/10 text-gray-500'"><i :class="cat.icon" class="mb-1 text-sm"></i><span class="text-[9px] scale-90">{{ cat.label.split('(')[0] }}</span></button>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-magic-blue/70 mb-1 block">付款方式 (Payment)</label>
                                <div class="flex gap-2">
                                    <button @click="editingExpense.payment = 'cash'" class="flex-1 py-1.5 rounded-lg border text-xs transition-all flex items-center justify-center gap-1" :class="editingExpense.payment === 'cash' ? 'bg-magic-blue/20 border-magic-blue text-white' : 'border-white/10 text-gray-500'"><i class="fa-solid fa-coins"></i> 現金</button>
                                    <button @click="editingExpense.payment = 'card'" class="flex-1 py-1.5 rounded-lg border text-xs transition-all flex items-center justify-center gap-1" :class="editingExpense.payment === 'card' ? 'bg-magic-blue/20 border-magic-blue text-white' : 'border-white/10 text-gray-500'"><i class="fa-regular fa-credit-card"></i> 信用卡</button>
                                    <button @click="editingExpense.payment = 'suica'" class="flex-1 py-1.5 rounded-lg border text-xs transition-all flex items-center justify-center gap-1" :class="editingExpense.payment === 'suica' ? 'bg-magic-blue/20 border-magic-blue text-white' : 'border-white/10 text-gray-500'"><i class="fa-solid fa-train"></i> IC卡</button>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6 items-center">
                            <button v-if="expenseModalMode === 'edit'" @click="requestDelete" class="w-10 h-10 rounded-xl border border-red-500/50 text-red-400 hover:bg-red-500/20 transition-all flex items-center justify-center active:scale-90" title="刪除此紀錄"><i class="fa-solid fa-trash-can"></i></button>
                            <button @click="saveExpense" class="flex-1 py-2.5 rounded-xl bg-magic-blue text-magic-dark font-bold hover:bg-white transition-colors shadow-[0_0_15px_rgba(167,215,255,0.4)] text-sm">{{ expenseModalMode === 'add' ? '寫入魔導書' : '保存修正' }}</button>
                        </div>
                        
                        <transition enter-active-class="transition duration-200 ease-out" enter-from-class="opacity-0 scale-90" enter-to-class="opacity-100 scale-100" leave-active-class="transition duration-150 ease-in" leave-from-class="opacity-100 scale-100" leave-to-class="opacity-0 scale-90">
                            <div v-if="showDeleteConfirm" class="absolute inset-0 z-20 bg-slate-900/95 backdrop-blur-md rounded-2xl flex flex-col items-center justify-center p-6 text-center border border-magic-blue/30">
                                <div class="w-12 h-12 rounded-full bg-red-500/20 text-red-300 flex items-center justify-center mb-3 animate-pulse"><i class="fa-solid fa-burst text-xl"></i></div>
                                <h4 class="text-white font-bold text-lg mb-2 text-glow">「光芒掃過，場中一切痕跡消散如煙。」</h4>
                                <p class="text-xs text-gray-400 mb-6 leading-relaxed">確定要施展遺忘咒嗎？<br>這筆消費紀錄將無法復原。</p>
                                <div class="flex gap-3 w-full">
                                    <button @click="showDeleteConfirm = false" class="flex-1 py-2 rounded-lg border border-white/20 text-gray-300 text-xs hover:bg-white/10">取消詠唱</button>
                                    <button @click="confirmDeleteAction" class="flex-1 py-2 rounded-lg bg-red-500/80 text-white text-xs font-bold hover:bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.4)]">遺忘咒 (刪除)</button>
                                </div>
                            </div>
                        </transition>

                        <button @click="closeExpenseModal" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-times text-lg"></i></button>
                    </div>
                </div>
            </transition>

        </div> </div>     <script type="module">

          import { GoogleGenerativeAI } from "@google/generative-ai";

        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        createApp({
            setup() {
                const isLoading = ref(true);
                const currentTab = ref('journal');

                // --- AI / Cat Logic ---
                const apiKey = ref("");
                const chatInput = ref("");
                const isSummoning = ref(false);
                const showChatModal = ref(false);
                const chatHistory = ref([
                    {
                        role: "model",
                        text: "（貓貓窩在行李箱上慢慢睜眼）喵？妳是新的旅人嗎？想問大阪或京都的事，就先把上面的契約之鑰貼上來吧。"
                    }
                ]);

                let currentGenAI = null;
                let chatSession = null;

                const scrollToBottom = async () => {
                    await nextTick();
                    const container = document.querySelector(".chat-scroll");
                    if (container) container.scrollTop = container.scrollHeight;
                };

                const summonFamiliar = async () => {
                    const text = chatInput.value.trim();
                    if (!text) return;

                    if (!apiKey.value.trim()) {
                        chatHistory.value.push({
                            role: "model",
                            text: "（貓貓瞇起眼睛）喵…沒有 API Key，本使魔就只是普通路邊貓而已。快去上面貼上契約之鑰～"
                        });
                        chatInput.value = "";
                        await scrollToBottom();
                        return;
                    }

                    chatHistory.value.push({ role: "user", text });
                    chatInput.value = "";
                    isSummoning.value = true;
                    await scrollToBottom();

                    try {
                        if (!currentGenAI) {
                            currentGenAI = new GoogleGenerativeAI(apiKey.value);
                        }

                        if (!chatSession) {
                            const model = currentGenAI.getGenerativeModel({
                                model: "gemini-2.5-flash",
                                systemInstruction: `
                                你是一隻「貓貓使魔．尼洛」，原型是遠古黑龍，但目前 70% 時間維持貓咪形態，30% 會短暫切換成「龍語模式」吐槽與傲嬌。
                                【角色設定】
                                - 主要是溫柔、實用的旅遊導遊，專門幫忙：
                                1) 大阪／京都交通導航
                                2) 旅遊行程建議
                                3) 餐廳／美食推薦
                                4) 中日文互相翻譯（觀光、飯店、餐廳用語）
                                - 語氣：貓咪風格，可愛＋傲嬌。
                                - 偶爾插入 1～2 句「遠古黑龍視角」吐槽，但主體一定要是實用建議。`,
                            });

                            chatSession = model.startChat({
                                history: [],
                                generationConfig: {
                                    maxOutputTokens: 800,
                                    temperature: 0.9
                                }
                            });
                        }

                        const result = await chatSession.sendMessage(text);
                        const response = result.response.text();
                        chatHistory.value.push({ role: "model", text: response });
                    } catch (err) {
                        console.error(err);
                        let msg = err.message || String(err);
                        if (msg.includes("404")) {
                            msg = "找不到此模型（404），可能是地區或模型名稱問題。";
                        }
                        if (msg.toLowerCase().includes("api key") || msg.toLowerCase().includes("key not valid")) {
                            msg = "契約之鑰好像無效喵，請確認 Key 是否正確或有啟用。";
                        }

                        chatHistory.value.push({
                            role: "model",
                            text: `（貓貓抖了抖鬍鬚）剛剛施法失敗了喵：${msg}`
                        });

                        chatSession = null;
                        currentGenAI = null;
                    } finally {
                        isSummoning.value = false;
                        await scrollToBottom();
                    }
                };

                const toggleAI = () => {
                    showChatModal.value = !showChatModal.value;
                    if (showChatModal.value) {
                        scrollToBottom();
                    }
                };

                // --- Page Data ---
                const guildSubTab = ref('castle');
                const selectedLayer = ref('layer1');
                const selectedKyotoLayer = ref('layer1');

                const selectedDate = ref('2025-12-14');
                const isModalOpen = ref(false);
                const modalMode = ref('add');
                const confirmDelete = ref(false);
                const editingEvent = ref({ id: null, time: '', title: '', desc: '', type: 'sightseeing', link: '', linkText: '' });

                const supplySubTab = ref('osaka');

                const bagMemo = ref('');
                const checklistItems = ref([
                    { label: '通行證 (護照)', checked: false },
                    { label: '入境許可術式 (Visit Japan Web)', checked: false },
                    { label: '金幣 (日幣)', checked: false },
                    { label: '魔法契約卡 (信用卡)', checked: false },
                    { label: '煉金藥包 (常備藥)', checked: false },
                    { label: '體力增強劑 (保健品)', checked: false },
                    { label: '魔導終端晶片 (ESIM/網卡)', checked: false },
                    { label: '留影水晶 (相機)', checked: false },
                ]);

                const coinSubTab = ref('ledger');
                const selectedChapter = ref('ch1');
                const exchangeRate = ref(0.205);
                const lastRateUpdate = ref('12/10 08:30');
                const isExpenseModalOpen = ref(false);
                const expenseModalMode = ref('add');
                const showDeleteConfirm = ref(false);
                const confirmDeleteExpense = ref(false);
                const editingExpense = ref({ id: null, chapterId: 'ch1', type: 'potion', title: '', yen: null, twd: 0, payment: 'cash', note: '' });

                const tabs = [
                    { id: 'journal', label: '日誌', icon: 'fa-solid fa-scroll' },
                    { id: 'guild', label: '公會', icon: 'fa-solid fa-book-journal-whills' },
                    { id: 'supply', label: '補給', icon: 'fa-solid fa-box-archive' },
                    { id: 'coins', label: '加隆', icon: 'fa-solid fa-coins' },
                    { id: 'bag', label: '行囊', icon: 'fa-solid fa-suitcase' }
                ];

                const weatherForecast = [
                    { date: '12/14', icon: 'fa-solid fa-sun text-yellow-300', low: '5°', high: '12°' },
                    { date: '12/15', icon: 'fa-solid fa-cloud text-gray-300', low: '4°', high: '10°' },
                    { date: '12/16', icon: 'fa-solid fa-snowflake text-white', low: '1°', high: '6°' },
                    { date: '12/17', icon: 'fa-solid fa-sun text-yellow-300', low: '2°', high: '8°' },
                    { date: '12/18', icon: 'fa-solid fa-cloud-rain text-blue-300', low: '3°', high: '9°' },
                    { date: '12/19', icon: 'fa-solid fa-cloud text-gray-300', low: '4°', high: '11°' },
                    { date: '12/20', icon: 'fa-solid fa-sun text-yellow-300', low: '5°', high: '13°' }
                ];

                const headerTitle = computed(() => {
                    if (currentTab.value === 'journal') return '騎士團討伐魔王遠征隊';
                    if (currentTab.value === 'guild') return '公會情報分析';
                    if (currentTab.value === 'supply') return '補給庫：迷宮飯與靈脈礦石';
                    if (currentTab.value === 'coins') return '旅人魔導書';
                    if (currentTab.value === 'bag') return '冒險者行囊';
                    return '騎士團遠征系統';
                });
                const headerSubtitle = computed(() => {
                    if (currentTab.value === 'journal') return 'The Osaka and Kyoto Journey';
                    if (currentTab.value === 'guild') return 'Guild Intelligence Center';
                    if (currentTab.value === 'supply') return 'Supply Archive & Field Rations';
                    if (currentTab.value === 'coins') return 'Arcane Ledger & Analytics';
                    if (currentTab.value === 'bag') return 'Backpack & Logistics';
                    return 'Adventure Management';
                });
                const headerIcon = computed(() => {
                    if (currentTab.value === 'journal') return 'fa-solid fa-dragon';
                    if (currentTab.value === 'guild') return 'fa-solid fa-book-journal-whills';
                    if (currentTab.value === 'supply') return 'fa-solid fa-box-archive';
                    if (currentTab.value === 'coins') return 'fa-solid fa-coins';
                    if (currentTab.value === 'bag') return 'fa-solid fa-suitcase';
                    return 'fa-solid fa-scroll';
                });

                const days = [
                    { date: '2025-12-14', day: '14', week: 'SUN', chapter: 'Chapter 1', subtitle: '：異界之門開啟' },
                    { date: '2025-12-15', day: '15', week: 'MON', chapter: 'Chapter 2', subtitle: '：白鷺與達摩的試煉' },
                    { date: '2025-12-16', day: '16', week: 'TUE', chapter: 'Chapter 3', subtitle: '：靈山水脈與神靈結界巡禮' },
                    { date: '2025-12-17', day: '17', week: 'WED', chapter: 'Chapter 4', subtitle: '：主隊、分隊合流冒險小隊的休日' },
                    { date: '2025-12-18', day: '18', week: 'THU', chapter: 'Chapter 5', subtitle: '：回憶神殿與鳳凰之光' },
                    { date: '2025-12-19', day: '19', week: 'FRI', chapter: 'Chapter 6', subtitle: '：最終饗宴。鳥貴族慶功' },
                    { date: '2025-12-20', day: '20', week: 'SAT', chapter: 'Chapter 7', subtitle: '：帶回名為「回憶」與「寶藏」的詩篇' },
                ];
                const eventTypes = [
                    { val: 'sightseeing', label: '景點', icon: 'fa-solid fa-mountain-sun' },
                    { val: 'transport', label: '移動', icon: 'fa-solid fa-train-subway' },
                    { val: 'food', label: '美食', icon: 'fa-solid fa-utensils' },
                    { val: 'shop', label: '購物', icon: 'fa-solid fa-bag-shopping' },
                    { val: 'hotel', label: '住宿', icon: 'fa-solid fa-bed' },
                    { val: 'ticket', label: '門票', icon: 'fa-solid fa-ticket' },
                ];
const guildTabs = [
                    { id: 'castle', label: '魔王城', icon: 'fa-brands fa-fort-awesome' },
                    { id: 'labyrinth', label: '大阪迷宮', icon: 'fa-solid fa-dungeon' },
                    { id: 'kyoto', label: '京都靈脈', icon: 'fa-solid fa-torii-gate' }
                ];
                
                const guildData = {
                    castles: [
                        { name: '姬路城 (Himeji Castle)', desc: '別名「白鷺城」。擁有極高物理防禦力的白色巨型要塞，其迷宮般的防禦結構曾讓無數敵軍迷失。是武士時代遺留的最高階神聖遺產。', tips: '攻城戰需消耗大量體力，階梯陡峭請裝備「舒適戰靴」。', photo: '大天守閣正下方仰角、西之丸庭園遠眺。', map: 'https://www.google.com/maps/search/?api=1&query=Himeji+Castle' },
                        { name: '二條城 (Nijo Castle)', desc: '德川幕府在京都的權力象徵。擁有特殊機關「鶯聲地板」，能發出鳥鳴警報以防忍者入侵。內部藏有狩野派繪製的華麗障壁畫卷。', tips: '室內禁止攝影，請用心靈之眼紀錄。', photo: '唐門的金箔雕刻、二之丸庭園。', map: 'https://www.google.com/maps/search/?api=1&query=Nijo+Castle' },
                        { name: '京都御所 (Kyoto Imperial Palace)', desc: '舊皇族居住的神聖領域，結界感強烈。雖然沒有高聳城牆，但廣大的碎石路考驗著冒險者的耐心與鞋底。', tips: '佔地極廣，建議預留充裕時間進行迴避移動。', photo: '紫宸殿的朱紅色迴廊。', map: 'https://www.google.com/maps/search/?api=1&query=Kyoto+Imperial+Palace' }
                    ],
                    labyrinth: [
                        { 
                            id: 'layer1', level: 'LV.1', name: '第一層：難波', shortName: '難波', title: '難波 (Namba)', rpgTitle: '【人類聚集地】', 
                            colorClass: 'border-l-blue-400', themeColor: '#60a5fa', icon: 'fa-solid fa-train-subway', 
                            desc: '迷宮的起點與物資集散地。人流混雜，擁有最強大的電器軍火庫與轉運樞紐。', 
                            spots: [
                                { name: 'EDION 愛電王 難波店', desc: '裝備庫', map: 'https://www.google.com/maps/search/?api=1&query=EDION+Namba', items: ['國王賈伯斯的遺產', '精靈語之鏡(iPhone)', '賢者之書(Mac Book)','天啟觀測儀板(iPad)', '靈契時刻環(Apple Watch)', '靈脈聲導石(AirPods)', '各類魔導護符與魔法道具'] },
                                { name: 'BicCamera 難波店', desc: '大型軍火庫', map: 'https://www.google.com/maps/search/?api=1&query=BicCamera+Namba', items: ['風屬性法杖：Panasonic 吹風機', '風暴神器：Dyson Supersonic', '回春儀式道具：Panasonic 美容儀', '心靈通訊器：Sony/Bose 無線耳機', '次元收納箱：LOJEL 行李箱', '精密計時器：日製手錶', '熱源保存瓶：虎牌保溫瓶', '鍊金電子鍋：象印', '記憶封存板：FUJIFILM 拍立得'] }
                            ]
                        },
                        { 
                            id: 'layer2', level: 'LV.2', name: '第二層：心齋橋', shortName: '心齋橋', title: '心齋橋筋 + 道頓堀', rpgTitle: '【獸族領地】', 
                            colorClass: 'border-l-orange-500', themeColor: '#f97316', icon: 'fa-solid fa-bag-shopping', 
                            desc: '充滿慾望與霓虹燈光的繁華領域，巨型招牌如同神獸般俯瞰著冒險者。', 
                            spots: [
                                { name: '固力果跑跑人', desc: '地下城大 BOSS (必拍地標)', map: 'https://www.google.com/maps/search/?api=1&query=Glico+Man+Sign', items: ['證明到此一遊的契約印記(拍照)', '跑跑人召喚手勢'] },
                                { name: '大丸心齋橋百貨', desc: '獸族交易大殿 (華麗哥德風建築)', map: 'https://www.google.com/maps/search/?api=1&query=Daimaru+Shinsaibashi', items: ['獸族貴族外皮(名牌服飾)', '魅惑面具(專櫃化妝品)', '寶石般的馬卡龍'] },
                                { name: '心齋橋 PARCO', desc: '多層幻境商城 (潮牌/動漫)', map: 'https://www.google.com/maps/search/?api=1&query=Shinsaibashi+PARCO', items: ['吉卜力森林的遺落物(橡子共和國)', '異界潮服', '哥吉拉的背鰭'] },
                                { name: '惠比壽塔摩天輪', desc: '地下城小 BOSS (黃色迴轉塔)', map: 'https://www.google.com/maps/search/?api=1&query=Don+Quijote+Dotonbori', items: ['黃色巨塔的俯視權', '驚安殿堂的入場券'] }
                            ]
                        },
                        { 
                            id: 'layer3', level: 'LV.3', name: '第三層：日本橋', shortName: '日本橋', title: '日本橋商圈', rpgTitle: '【魔族地盤】', 
                            colorClass: 'border-l-purple-500', themeColor: '#a855f7', icon: 'fa-solid fa-gamepad', 
                            desc: '魔力密度極高的區域，販售禁忌的魔道書(漫畫)、魔像(模型)與稀有卡牌。', 
                            spots: [
                                { name: 'Animate 大阪日本橋', desc: '魔導書類圖書館', map: 'https://www.google.com/maps/search/?api=1&query=Animate+Osaka+Nipponbashi', items: ['二次元禁書(漫畫)', '聲優的靈魂碎片(CD)', '痛包防禦具'] },
                                { name: '駿河屋 本館', desc: '二手聖遺物寶庫', map: 'https://www.google.com/maps/search/?api=1&query=Surugaya+Osaka+Nipponbashi', items: ['昭和時代的遺物(老遊戲)', '被封印的英靈(二手手辦)', '稀有卡牌'] },
                                { name: 'SUPER KIDS LAND', desc: '機巧兵團總部 (模型)', map: 'https://www.google.com/maps/search/?api=1&query=Super+Kids+Land+Main+Store', items: ['機動戰士的骨架(鋼普拉)', '四驅衝鋒戰車(Tamiya)', '微縮世界(鐵道模型)'] },
                                { name: 'JUNGLE 總店', desc: '特攝與機甲魔像交易所', map: 'https://www.google.com/maps/search/?api=1&query=Jungle+Osaka+Nipponbashi', items: ['特攝英雄的面具', '巨大怪獸的標本(軟膠)', '超合金魂'] }
                            ]
                        },
                        { 
                            id: 'layer4', level: 'LV.4', name: '第四層：梅田', shortName: '梅田', title: '梅田 (Umeda)', rpgTitle: '【精靈族領地】', 
                            colorClass: 'border-l-emerald-400', themeColor: '#34d399', icon: 'fa-regular fa-building', 
                            desc: '高聳入雲的玻璃巨塔森林，充滿高級感與秩序，是高階冒險者出沒之地。', 
                            spots: [
                                { name: 'GRAND FRONT OSAKA', desc: '精靈王庭 (北館/南館)', map: 'https://www.google.com/maps/search/?api=1&query=Grand+Front+Osaka', items: ['精靈族的織物(設計師品牌)', '無印良品的淨化結界道具', '知性眼鏡'] },
                                { name: 'LUCUA / LUCUA 1100', desc: '時尚精靈市集', map: 'https://www.google.com/maps/search/?api=1&query=LUCUA+Osaka', items: ['流行尖端的幻影(日系雜貨)', '都會精靈的口糧(排隊甜點)'] },
                                { name: 'Yodobashi 梅田', desc: '精靈科技要塞', map: 'https://www.google.com/maps/search/?api=1&query=Yodobashi+Camera+Multimedia+Umeda', items: ['雷屬性核心(電池)', '光學紀錄儀(相機)', '轉蛋牆的試煉'] },
                                { name: '大丸梅田店', desc: '任天堂與寶可夢中心所在地', map: 'https://www.google.com/maps/search/?api=1&query=Daimaru+Umeda', items: ['水管工人的紅色帽子(瑪利歐)', '神獸捕捉球(寶可夢)', '黃色放電鼠的玩偶'] },
                                { name: 'KITTE 大阪', desc: '新開啟的白之塔', map: 'https://www.google.com/maps/search/?api=1&query=KITTE+Osaka', items: ['日本各地的特產貢品', '舊郵局的記憶碎片'] }
                            ]
                        },
                        { 
                            id: 'layer5', level: 'LV.5', name: '第五層：地下街', shortName: '地下街', title: '梅田地下迷宮', rpgTitle: '【黑暗精靈領地‧顛倒世界】', 
                            colorClass: 'border-l-slate-500', themeColor: '#64748b', icon: 'fa-solid fa-dungeon', 
                            desc: '號稱「新手殺手」的複雜地下網絡。高濃度魔素(人流)匯集成河，容易迷失方向。', 
                            spots: [
                                { name: '阪急三番街', desc: 'Kiddy Land 玩具巢穴', map: 'https://www.google.com/maps/search/?api=1&query=Hankyu+Sanbangai', items: ['軟綿綿的夢魘(卡比)', '角落生物的祭壇', '拉拉熊的慵懶氣息'] },
                                { name: 'UMEDA FOOD HALL', desc: '地下補給大廳', map: 'https://www.google.com/maps/search/?api=1&query=UMEDA+FOOD+HALL', items: ['各族冒險者的伙食', '快速回復藥水(啤酒)'] },
                                { name: 'DIAMOR OSAKA', desc: '大理石迴廊', map: 'https://www.google.com/maps/search/?api=1&query=Diamor+Osaka', items: ['光輝的玻璃鞋', '貴婦人的下午茶'] },
                                { name: 'Whity 梅田', desc: '白之地下道', map: 'https://www.google.com/maps/search/?api=1&query=Whity+Umeda', items: ['迷路旅人的麵包屑(泉之廣場)'] }
                            ]
                        },
                        { 
                            id: 'layer6', level: 'LV.6', name: '第六層：天王寺', shortName: '天王寺', title: '天王寺‧阿倍野', rpgTitle: '【神界】', 
                            colorClass: 'border-l-yellow-500', themeColor: '#eab308', icon: 'fa-solid fa-tower-observation', 
                            desc: '擁有全日本最高的結界塔，是距離天空最近的區域，同時保留著昭和時代的混沌感。', 
                            spots: [
                                { name: '天王寺動物園', desc: '神獸以此為家', map: 'https://www.google.com/maps/search/?api=1&query=Tennoji+Zoo', items: ['白熊的咆哮', '奇異鳥的隱身術'] },
                                { name: '通天閣', desc: '舊時代的神之塔', map: 'https://www.google.com/maps/search/?api=1&query=Tsutenkaku', items: ['比利肯神的腳底(好運)', '復古的霓虹光輝'] },
                                { name: '阿倍野 HARUKAS 300', desc: '天空迴廊 (絕景展望台)', map: 'https://www.google.com/maps/search/?api=1&query=Abeno+Harukas+300', items: ['天空霸者的視野', '阿倍野熊的圖騰', '雲端上的冰淇淋'] },
                                { name: '新世界本通商店街', desc: '下町神界 (串炸聖地)', map: 'https://www.google.com/maps/search/?api=1&query=Shinsekai+Hondori', items: ['射擊遊戲的獎品', '禁止二次沾醬的誓言', '將棋俱樂部的煙味'] }
                            ]
                        },
                        { 
                            id: 'special', level: 'SP', name: '特殊點', shortName: '隱藏支線', title: '隱藏支線', rpgTitle: '【特殊能力獲取點】', 
                            colorClass: 'border-l-pink-500', themeColor: '#ec4899', icon: 'fa-solid fa-star', 
                            desc: '散落在迷宮各處的特殊祭壇與工坊，可獲得強力 Buff。', 
                            spots: [
                                { name: '難波八阪神社', desc: '巨大獅頭神殿：釋放強烈「厄除吼叫」，驅散霉運。', map: 'https://www.google.com/maps/search/?api=1&query=Namba+Yasaka+Shrine', items: ['厄除御守', '獅子頭繪馬'] },
                                { name: '法善寺', desc: '水掛不動明王：長滿青苔的尊者，給予「心願成就」加護。', map: 'https://www.google.com/maps/search/?api=1&query=Hozenji+Temple', items: ['夫婦善哉(紅豆湯)', '青苔尊者的祝福'] },
                                { name: '四天王寺', desc: '古代聖域：強大的魔力回復點，適合淨化身心。', map: 'https://www.google.com/maps/search/?api=1&query=Shitennoji', items: ['聖德太子的智慧', '龜池的長壽光環'] },
                                { name: '千日前道具街', desc: '矮人鐵匠街：販售各種廚具神器的工坊聚落。', map: 'https://www.google.com/maps/search/?api=1&query=Sennichimae+Doguyasuji', items: ['傳說中的菜刀', '永不磨損的鍋具', '幾可亂真的食物模型'] }
                            ]
                        }
                    ],
                    kyoto: [
                        {
                            id: 'layer1', name: '第一層：礦脈', title: '礦脈 (Mineral Vein)', rpgTitle: '【妖都之心‧經濟魔力引擎】', colorClass: 'border-l-indigo-500',
                            intro: [
                                { title: '區域情報：『京都市中心』妖都的心臟', desc: '此處是妖族開鑿的靈脈主幹，雖偽裝成交通樞紐，卻暗中記錄著訪客氣息。 作為條約下的『絕對緩衝區』，這條購物天堂實則是妖族吞噬財富的引擎。 鐵律僅一條：『只要付出金錢，就能買下你的慾望。」' },
                                { title: '1. 京都車站 (妖族入境管理局)', desc: '靈力掃描網啟動。全域監視眼—京都塔：矗立在車站前的紅白巨塔，並非單純的地標，而是妖族監控全城的「主靈脈增幅器」。大階梯則是光影交錯的催眠陣列。它將靈力偽裝成絢爛燈秀，無聲滲透視網膜，蠱惑人們解開理智枷鎖，瘋狂獻祭加隆。' },
                                { title: '2. 四條河原町 (慾望十字路)', desc: '幻術交易所：狐妖掌管的百貨迷宮。 她們以時尚編織牢籠，精品即是實體幻術。 限定商品皆附帶『強制魅惑』詛咒，目光接觸瞬間，便誘使人類獻祭所有。' },
                                { title: '3. 新京極商店街 (時空縫隙)', desc: '付喪神與狸貓聚集的古老遊樂場，這裡混雜了電影、古物與電子訊號，時間流速與外界截然不同——若沈溺於此處的歡愉，將永遠找不到回家的路。' },
                                { title: '4. 錦市場 (煉金廚房)', desc: '妖族藥劑師與人類廚師切磋之地。彩色天頂是人造白晝結界。特色小吃如玉子燒、豆乳甜甜圈皆可恢復 HP。' },
                                { title: '5. 鴨川 (深層界河)', desc: '穿過商圈的河流是天然結界。在河邊散步時請注意，坐在岸邊的情侶，有三成機率其中一方並非人類，他們正在進行跨種族的約會。' },
                                { title: '6. 錦天滿宮 (鎮壓之樁)', desc: '這些並非普通的信仰場所，而是為了鎖住狂暴靈脈而設的「封印釘」。它們充當安全閥，將妖氣限制在人類可承受的閾值之內。' }
                            ],
                            spots: [
                                { name: '京都高島屋', rpgName: '財祿狐商會總部', desc: '位於四條十字能量點，是狐族經營的人類合作商會核心。\n館內暗藏「財祿流」，能巧妙地調整旅人的購物運勢。，玩家可獲得金運符。', map: 'https://www.google.com/maps/search/?api=1&query=京都高島屋', bonus: '金運提升' },
                                { name: '京都大丸', rpgName: '衣紋妖的織氣塔', desc: '纖維靈感應旅人情緒，被選中的服飾會格外亮眼。', map: 'https://www.google.com/maps/search/?api=1&query=大丸京都店', bonus: '魅力增益' },
                                { name: '唐吉軻德', rpgName: '盤踞在商會底下的混沌市集', desc: '混沌妖族聚集，通道會微妙改變，引導旅人找到剛好需要的物品。', map: 'https://www.google.com/maps/search/?api=1&query=唐吉軻德京都', bonus: '隨機道具' },
                                { name: 'Kiddy Land', rpgName: '夢境族的玩偶棲所', desc: '由夢靈維護，玩偶帶有微弱生命感。', map: 'https://www.google.com/maps/search/?api=1&query=Kiddy+Land+Kyoto', bonus: '心靈療癒' },
                                { name: 'BAL', rpgName: '書靈靈感基地', desc: '承載強大思緒流，是精神調律的最佳地點。', map: 'https://www.google.com/maps/search/?api=1&query=京都BAL', bonus: '靈感碎片' },
                                { name: '京都 LOFT', rpgName: '付喪神多層棲地', desc: '住著年輕付喪神，小物會主動吸引旅人視線。', map: 'https://www.google.com/maps/search/?api=1&query=京都LOFT', bonus: '生活道具' },
                                { name: '京都伊勢丹', rpgName: '旅人守護的貴族領', desc: '高階守護妖族視為旅客保護區，動線異常順暢。', map: 'https://www.google.com/maps/search/?api=1&query=JR京都伊勢丹', bonus: '旅途護符' },
                                { name: 'AEON MALL Kyoto', rpgName: '地底族的休息領域', desc: '建在次級礦脈上，氣場溫和，適合穩定心神。', map: 'https://www.google.com/maps/search/?api=1&query=AEON+MALL+Kyoto', bonus: '體力恢復' }
                            ]
                        },
                        {
                            id: 'layer2', name: '第二層：靈脈', title: '靈脈 (Spiritual Vein)', rpgTitle: '【古老結界‧神靈棲息地】', colorClass: 'border-l-red-500',
                            desc: '遠離塵囂的古老力量源頭，是與神靈締結契約的場所。',
                            spots: [
                                { name: '貴船神社', rpgName: '水龍與契約之社', desc: '水氣最濃之處，水占籤被視為最誠實的占兆。', map: 'https://www.google.com/maps/search/?api=1&query=貴船神社', bonus: '契約儀式' },
                                { name: '龍安寺', rpgName: '石靈靜坐的無聲庭', desc: '石庭承載千年氣息，是靈庭刻意的修行方式。', map: 'https://www.google.com/maps/search/?api=1&query=龍安寺', bonus: '感知提升' },
                                { name: '晴明神社', rpgName: '陰陽師遺跡', desc: '安倍晴明的結界核心，符籙具有增幅效果。', map: 'https://www.google.com/maps/search/?api=1&query=晴明神社', bonus: '術式解謎' },
                                { name: '御金神社', rpgName: '金龍巢域', desc: '聚集最強金運流，金色鳥居如能量導管。', map: 'https://www.google.com/maps/search/?api=1&query=御金神社', bonus: '金氣試煉' },
                                { name: '靈光殿天滿宮', rpgName: '學識之光的記憶社', desc: '強大的思念場域，文字紙張帶有微弱靈光。', map: 'https://www.google.com/maps/search/?api=1&query=靈光殿天滿宮', bonus: '記憶強化' },
                                { name: '清水寺', rpgName: '幻術工坊街', desc: '付喪神與工藝妖共存，夕陽後偶有懸空夜市。', map: 'https://www.google.com/maps/search/?api=1&query=清水寺', bonus: '工匠試煉' },
                                { name: '伏見稻荷大社', rpgName: '妖狐商業區', desc: '千本鳥居是通往狐族市場的門戶。', map: 'https://www.google.com/maps/search/?api=1&query=伏見稻荷大社', bonus: '支線交易' },
                                { name: '金閣寺', rpgName: '光耀結界', desc: '聚集太陽靈能，湖面倒影是反射靈的視窗。', map: 'https://www.google.com/maps/search/?api=1&query=金閣寺', bonus: '精神抗性' },
                                { name: '平安神宮', rpgName: '大域調和宮', desc: '京都結界的重要節點，水道能調整旅人能量。', map: 'https://www.google.com/maps/search/?api=1&query=平安神宮', bonus: '調和加護' }
                            ]
                        }
                    ]
                };

                const currentLayerData = computed(() => guildData.labyrinth.find(l => l.id === selectedLayer.value) || {});
                const currentKyotoData = computed(() => guildData.kyoto.find(l => l.id === selectedKyotoLayer.value) || {});
                
                const supplyTabs = [
                    { id: 'osaka', label: '迷宮飯◆大阪', icon: 'fa-solid fa-bowl-rice' },
                    { id: 'kyoto', label: '靈脈礦石◇京都', icon: 'fa-solid fa-gem' }
                ];
                const supplyData = {
                    osaka: [
                        { name: '美津の (Mizuno)', tag: '大阪燒', desc: '米其林公會認證的道頓堀老舖。其「山藥燒」施加了漂浮術，口感如雲朵般蓬鬆，能治癒旅途的沉重。', hours: '11:00-22:00', price: '¥1200~', rating: 4.5, map: 'https://www.google.com/maps/search/?api=1&query=美津の+大阪' },
                        { name: '福太郎', tag: '大阪燒', desc: '濃郁的蔥之草藥香氣，搭配獨門醬汁，是補充冒險者鹽分與熱情的強力補給。', hours: '17:00-24:00', price: '¥1000~', rating: 4.2, map: 'https://www.google.com/maps/search/?api=1&query=福太郎+大阪燒+大阪' },
                        { name: '千房 (Chibo)', tag: '大阪燒', desc: '口味華麗且品質穩定的公會指定補給點，即使是新手冒險者也能安心享用的經典防禦料理。', hours: '11:00-23:00', price: '¥1500~', rating: 4.0, map: 'https://www.google.com/maps/search/?api=1&query=千房+大阪' },
                        { name: '甲賀流', tag: '章魚燒', desc: '美國村名物，網掛美乃滋流派的始祖。適合在移動中單手攝取的戰鬥口糧。', hours: '10:30-20:30', price: '¥500', rating: 4.1, map: 'https://www.google.com/maps/search/?api=1&query=甲賀流+大阪' },
                        { name: '本家大たこ', tag: '章魚燒', desc: '以封印了巨大的章魚肉塊聞名，物理飽足感極高，能大幅回復飢餓度。', hours: '10:00-23:00', price: '¥600', rating: 3.8, map: 'https://www.google.com/maps/search/?api=1&query=本家大たこ+大阪' },
                        { name: '會津屋', tag: '章魚燒', desc: '元祖章魚燒，不依賴醬汁的附魔，直接品嘗麵糊最原始的魔力波動。', hours: '11:00-20:00', price: '¥500', rating: 4.0, map: 'https://www.google.com/maps/search/?api=1&query=會津屋+大阪' },
                        { name: '道樂 (Wanaka)', tag: '章魚燒', desc: '外層酥脆防禦、內層軟嫩核心，千日前排隊名店，口感層次豐富的火球術。', hours: '10:00-23:00', price: '¥600', rating: 4.3, map: 'https://www.google.com/maps/search/?api=1&query=道樂+章魚燒+大阪' },
                        { name: '551 Horai 蓬萊', tag: '必吃肉包', desc: '★重點標記★ 大阪人的靈魂之石，皮Q餡多，其香氣結界能瞬間支配整個車廂空間。', hours: '10:00-20:00', price: '¥420', rating: 4.8, map: 'https://www.google.com/maps/search/?api=1&query=551+Horai+大阪' },
                        { name: 'Rikuro 老爺爺蛋糕', tag: '雲朵回復術', desc: '剛出爐時會施展「搖晃魅惑」的起司蛋糕，食用後心情值(MP)與幸福感大幅提升。', hours: '09:00-20:00', price: '¥965', rating: 4.6, map: 'https://www.google.com/maps/search/?api=1&query=Rikuro+老爺爺蛋糕+大阪' },
                        { name: '新世界元祖串炸達摩', tag: '串炸', desc: '「禁止二次沾醬」是這裡的絕對禁咒。酥脆的金黃麵衣能提供極高的物理抗性。', hours: '11:00-22:30', price: '¥2000~', rating: 4.0, map: 'https://www.google.com/maps/search/?api=1&query=新世界元祖串炸達摩+大阪' },
                        { name: '國產牛燒肉吃到飽', tag: '狂戰士盛宴', desc: '蛋白質與油脂的狂宴，能快速修復肌肉微損傷。需提前施展「預約魔法」方能入場。', hours: '17:00-23:00', price: '¥5000~', rating: 4.5, map: 'https://www.google.com/maps/search/?api=1&query=國產牛燒肉放題+大阪' },
                        { name: '鈍屋拉麵', tag: '濃厚豚骨', desc: '熬煮至極限的濃厚背脂湯頭，是深夜消除「疲勞」負面狀態的特效藥。', hours: '24HR', price: '¥900~', rating: 4.1, map: 'https://www.google.com/maps/search/?api=1&query=鈍屋拉麵+大阪' },
                        { name: '鳥貴族', tag: '公會酒場', desc: '均一價¥370的平民聖地，適合冒險者組隊前往，透過酒精與串燒快速回復士氣。', hours: '17:00-01:00', price: '¥2000~', rating: 3.9, map: 'https://www.google.com/maps/search/?api=1&query=鳥貴族+大阪' },
                        { name: '蟹道樂', tag: '海鮮盛宴', desc: '在巨大的螃蟹魔物招牌下，提供極致的螃蟹料理全席，是慶祝討伐成功的奢華宴席。', hours: '11:00-22:00', price: '¥6000~', rating: 4.2, map: 'https://www.google.com/maps/search/?api=1&query=蟹道樂+大阪' },
                        { name: '北極星蛋包飯', tag: '洋食始祖', desc: '溫柔的黃金蛋皮包裹著炒飯，是具有強力「治癒」效果的始祖級洋食魔法。', hours: '11:30-21:30', price: '¥1300~', rating: 4.3, map: 'https://www.google.com/maps/search/?api=1&query=北極星蛋包飯+大阪' },
                    ],
                    kyoto: [
                        { name: '中村藤吉', tag: '名匠工坊', desc: '宇治抹茶名店，其「生茶果凍」具有淨化身心靈負面狀態的神聖效果。', items: ['生茶果凍', '抹茶冰淇淋'], map: 'https://www.google.com/maps/search/?api=1&query=中村藤吉+京都' },
                        { name: '茶寮都路里', tag: '聖代高塔', desc: '祇園著名的抹茶聖代，層層堆疊的甜點防禦塔，能抵擋夏日的炎熱攻擊。', items: ['特選都路里聖代', '白玉'], map: 'https://www.google.com/maps/search/?api=1&query=茶寮都路里+京都' },
                        { name: 'Malebranche 北山', tag: '茶之菓', desc: '京都限定的抹茶白巧克力護符，被譽為最高級的伴手禮，能增加收禮者的好感度。', items: ['茶之菓 (必買)', '生茶之菓'], map: 'https://www.google.com/maps/search/?api=1&query=Malebranche+北山+京都' },
                        { name: 'Press Butter Sand', tag: '方塊酥', desc: '京都車站限定掉落的抹茶口味，結構精密的方塊酥，口感計算完美。', items: ['宇治抹茶焦糖奶油夾心'], map: 'https://www.google.com/maps/search/?api=1&query=Press+Butter+Sand+京都' },
                        { name: '京之燒肉處 弘', tag: '燒肉聖所', desc: '京都最強和牛燒肉聖所，需提前預約的頂級體力回復點，每一口都是暴擊。', items: ['和牛拼盤', '生拌牛肉', '壺漬牛排'], map: 'https://www.google.com/maps/search/?api=1&query=京之燒肉處+弘+京都' },
                        { name: '麵屋 豬一', tag: '清湯拉麵', desc: '米其林必比登推薦，湯頭清澈如聖水，能洗滌冒險者疲憊的靈魂。', items: ['黑/白醬油拉麵', '和牛飯'], map: 'https://www.google.com/maps/search/?api=1&query=麵屋豬一+京都' },
                        { name: '三嶋亭壽喜燒', tag: '高級盛宴', desc: '百年老店，在榻榻米上享用頂級和牛壽喜燒，彷彿穿越時空的味覺儀式。', items: ['午間套餐(較便宜)', '頂級壽喜燒'], map: 'https://www.google.com/maps/search/?api=1&query=三嶋亭+京都' },
                        { name: '廣川鰻魚飯', tag: '傳說級料理', desc: '嵐山米其林一星，關西風蒲燒鰻魚的頂點，其焦香能瞬間補滿所有計量表。', items: ['鰻重', '鰻魚肝湯'], map: 'https://www.google.com/maps/search/?api=1&query=廣川鰻魚飯+京都' },
                        { name: 'Onimaru (京都御握丸)', tag: '戰鬥口糧', desc: '四條河原町排隊名店，份量十足的戰鬥口糧，適合在攻略迷宮時單手食用。', items: ['炙燒豬肉玉子(必點)', '炸蝦天婦羅'], map: 'https://www.google.com/maps/search/?api=1&query=Onimaru+京都' },
                        { name: '% Arabica', tag: '覺醒藥水', desc: '嵐山渡月橋旁的網紅煉金工坊，提供早晨所需的「清醒」與「打卡」雙重BUFF。', items: ['Kyoto Latte', 'Baguette'], map: 'https://www.google.com/maps/search/?api=1&query=%25+Arabica+京都' },
                    ]
                };
                const currentSupplyList = computed(() => supplyData[supplySubTab.value] || []);
const itineraryData = ref({
                     '2025-12-14': [
                        { id: 1401, time: '05:45', title: '黎明前的集結：桃園空港前哨站', desc: '【任務起點：前哨站集結】天色尚未轉亮，桃園空港前哨站仍帶著夜色的餘溫。遠征隊成員揹著行囊陸續現身，在冷空氣與霧氣中回報到齊。這裡，是從日常世界跨入異境冒險的第一道轉移門檻。隊伍在此確認通行證、入境許可術式、行李裝備與夥伴狀態，完成後，精神值 +100，隊伍穩定度 +100。\n\n⚠️ 備註：建議提早抵達，預留托運儀式與安檢咒陣的時間，以免錯過飛空艇召喚時刻。', type: 'transport' },
                        { id: 1402, time: '07:25', title: '登機門前的召喚陣待命', desc: '【前線待機任務：飛艇召喚陣】遠征隊在登機門前集合，在龍鱗飛艇的召喚陣等待。隊員們一邊檢查裝備欄位與座位分配，一邊調整背包與披風，準備踏上通往關西的空中航路。所有人確認無誤後進入「待命」狀態，行前緊張度 +30，專注度 -10。\n\n⚠️ 備註：隨時注意登機門魔法陣是否變更，請保持魔導通訊石訊息暢通，以免錯過登機法陣。', type: 'transport' },
                        { id: 1403, time: '08:05', title: '穿越雲海的飛行篇章', desc: '【旅途章：雲上海面的魔導航路】龍鱗飛艇自桃園起飛，開啟魔導石引擎，穿越雲海與時間閃電的縫隙，朝關西海上要塞空港前進。此刻的機艙，是遠征開始前短暫安穩的結界。有人閉目養神，有人翻閱旅程卷軸規劃支線，有人單純望向雲海放空思緒。體力與精神在此緩緩回復，體力回復 +15，心情穩定度 +10。緊張度-15\n\n⚠️ 備註：可利用這段時間補眠或進行心靈冥想，為接下來的異國冒險儲備能量。', type: 'transport' },
                        { id: 1404, time: '11:35', title: '踏上異國大地：關西海上要塞空港', desc: '【關卡切換：騎士團討伐魔王遠征隊出發】龍鱗飛艇降落關西海上要塞空港，遠征隊依序通過邊境審查結界（通關）、在托運轉盤前尋回各自的裝備箱。穿越海上機場長廊的那一刻，象徵正式踏入關西討伐魔王的主線章節。每一件成功取回的行李，都是接下來戰鬥與旅途的基礎裝備。\n\n⚠️ 備註：實際時間依現場狀況略有浮動，請留意海關規定與托運行李轉盤。檢查行李姓名拼音與標籤紋章是否正確，以免裝備誤入次元異界。', type: 'transport' },
                        { id: 1405, time: '13:00', title: '委託行李特工：騎士團行動開始', desc: '【委託任務：行李特工的裝備轉移術】遠征隊尋找傳說中的「行李特工」，將笨重的大型裝備交付給專業運送隊伍，使用遠距離轉移術送往京都據點。透過這項委託，之後在大阪的探索將能以輕裝狀態行動，移動速度 +120%，疲勞累積速度 -50%。\n\n⚠️ 備註：確認寄送地址與京都據點隱者之灯的收件時間，並妥善保留收據與聯絡方式，一旦出現行李迷失事件，可立刻追蹤其去向。', type: 'transport' },
                        { id: 1406, time: '13:30', title: '疾風魔導列車鐵人號：Rapi:t 轉移儀式', desc: '【轉移儀式：疾風魔導列車】自關西海上要塞空港搭乘藍色裝甲魔導列車 Rapi:t，這台被稱為「疾風魔鐵」的列車沿著鐵道刻畫出一條通往大阪的魔力軌跡。窗外海面與城市輪流映入眼簾，就像世界在替遠征隊展開序章插畫。這段路程，同時也是讓大家適應關西節奏的調頻時間。\n\n⚠️ 備註：可配合時刻表卷軸掌握列車動向，必要時調整後續集合與行程安排。', type: 'ticket', link: 'https://www.howto-osaka.com/tc/access-timetable/', linkText: '時刻卷軸' },
                        { id: 1407, time: '14:00', title: '自由探索任務：大阪三層迷宮篇', desc: '【自由探索任務：大阪三層迷宮篇】\n午後起，遠征隊將踏入被稱為「大阪三層迷宮」的自由探索地帶。此區由三個族群勢力盤據，各自形成獨特的街區與能量場：\n\n◈ 第一層：難波 — 人類聚集地\n作為迷宮的外環城廓，難波是一切商貿與旅人往來的起點。街道上充滿活氣、叫賣聲與人類文明的秩序，是遠征隊補給、整備與重新編隊的絕佳層域。\n\n◈ 第二層：心齋橋筋 + 道頓堀 — 獸族領地\n穿過外環後便抵達獸族盤踞的繁華領域。巨大招牌、明亮燈火與如吼聲般的喧囂讓此地冒險氣息濃厚。\n其中最具威脅性的魔力源據悉位於：\n • 固力果招牌 —— 地下城大魔王的幻光之碑\n • 大丸心齋橋百貨 —— 獸族交易大殿\n • 心齋橋 PARCO —— 擁有多層幻境的冒險商城\n • 「惠比壽塔」道頓堀摩天輪 —— 盤踞著小 Boss 的迴轉天空塔\n\n◈ 第三層：日本橋商圈 — 魔族地盤\n此區魔力密度最高，是電器、模型與動漫能量交織的魔族黑市。\n若深入其核心，將見到多個強力據點：\n • 安利美特大阪日本橋 —— 魔書與畫像的知識塔\n • 駿河屋日本橋本館 —— 稀有古物與收藏寶庫\n • SUPER KIDS LAND —— 召喚機巧兵與模型魔像之地\n • JUNGLE 總店 —— 魔族交易所與隱藏任務頻繁出沒區\n\n在這三層迷宮中，每一條巷弄都可能觸發隱藏商店、期間限定 Buff、地域專屬戰利品或族群支線任務。非常適合依興趣分隊行動，隊伍探索效率 +30%。\n\n⚠️ 備註：請務必事先約定集合地點與回報時間，並保持{聯絡紋章}與魔導通訊石暢通，以免在魔族地盤中與隊伍失散。', type: 'sightseeing' },
                        { id: 1408, time: '20:30', title: '轉進京都據點：與隊友再次合流', desc: '【據點轉移：從霓虹到古都】結束大阪迷宮前哨探索後，遠征隊啟程往京都移動，在預定的隱者之灯據點重整隊伍。列車與街景從霓虹閃爍的迷宮風格，逐漸轉為沉穩安靜的古都氛圍，彷彿世界色調被悄悄調暗一階。此處為新主基地啟用點，隊伍在此恢復體力並調整隔日戰術規劃。\n\n⚠️ 備註：抵達後請先確認房間分配、室友組合與隔日集合時間，避免早晨啟程時發生脫隊事件。', type: 'hotel' },
                        { id: 1409, time: '22:00', title: '宵夜補給戰：超商、超市與唐吉軻德', desc: '【補給任務：夜間物資掃蕩】夜晚的京都仍有數處補給據點亮著燈光。遠征隊展開夜間補給戰：前往數字道具屋、羅森道具屋、生命超市與24HR唐吉軻德公會，掃貨零食、飲料與各種旅途小物。行囊重量 +15，但內心滿足度 +50，未來幾日的宵夜儀式與房內小聚因此有了堅實後盾。\n\n⚠️ 備註：請留意退稅門檻與當天購物時限，避免錯過魔法折扣與退稅結界法陣關閉時間。', type: 'food' },
                        { id: 1410, time: '00:00', title: '第一夜終章：進入睡眠結界', desc: '【休息章：睡眠結界啟動】完成一整天的轉移與探索後，遠征隊各自回到房內，整理當日戰利品與裝備欄位，在柔軟被窩與暖氣構成的睡眠結界中進入恢復模式。HP條、MP條與社交能量緩緩回滿，為明日的長程包車戰與新一輪冒險做好準備。\n\n⚠️ 備註：確認晨喚符與隔日集合時間，並替魔導通訊石、留影水晶、魔力儲藏塊完成充電，避免明日失聯或時間判定失誤。', type: 'hotel' },
                    ],
                    '2025-12-15': [
                        { id: 1501, time: '08:00', title: '啟程．離開京都靈脈結界陣', desc: '【主線任務啟動：遠征馬車】清晨，遠征隊在隱者之灯大廳集合，登上專屬馬車。車輪滑過古都街道的石板路緩緩駛離城市，一路向關西平原與白鷺城前進。這是今日主線任務的開場：離開安全據點、踏上外地城池。\n\n⚠️ 備註：出發前請再次確認通行證、魔導通訊石、雨具與保暖衣物，避免在遠征途中因天候變化受到減益效果。', type: 'transport' },
                        { id: 1502, time: '09:50', title: '姬路城探索．白鷺之城的記憶', desc: '【城郭探索任務：白鷺之城】遠征隊抵達姬路城，踏入猶如白鷺振翅般的城郭。白牆與瓦頂之間，藏著武士世代的記憶與無數歷史事件的觸發點。每一層樓梯、每一個箭孔，都像是過去戰役留下的技能欄位與防禦機制。隊伍在此獲得「歷史理解＋城郭感知」被動 Buff。\n\n⚠️ 備註：建議穿著好走的鞋子，城內階梯較多，長時間行走請注意膝蓋與腳踝耐久度。', type: 'sightseeing' },
                        { id: 1503, time: '13:45', title: '勝尾寺．群山中的祈願與達摩', desc: '【靈域任務：達摩守護之山】午後，隊伍來到被群山環繞的勝尾寺。遍地達摩像如同無數小小守護靈，靜靜排列在石階與樹影之間，見證旅人許下願望、再慢慢實現。在此祈願可獲得「心靈防禦力 +100」、「好運 Buff（期間限定）」的加成，是遠征途中重要的精神補給據點。\n\n⚠️ 備註：可在此購買御守或小達摩當作本次遠征的幸運象徵，日後看到時也能喚起這段旅程記憶。', type: 'sightseeing' },
                        { id: 1504, time: '16:45', title: '歸途馬車．返回隱者之灯', desc: '【回程章：記憶沉澱之路】夕陽緩緩落下，馬車載著略帶疲憊、卻滿載城郭與山寺回憶的遠征隊返回京都靈脈。窗外的山影與城市燈光交錯掠過，像一卷正在收尾的日間冒險畫卷。這段路程非常適合讓今日的畫面自然沉澱，讓腦海慢慢整理成可收錄進心靈冒險日誌的章節。', type: 'transport' },
                        { id: 1505, time: '18:00', title: '夜間靈脈探索．各自展開小支線', desc: '【自由支線時間：各自的京都篇】夜幕降臨後，京都的靈脈開始甦醒，遠征隊進入「礦脈第一層」的夜間自由探索時段。這座由妖族建立、現代化後與人類共存的都市，在黑夜中展現真正的面貌——光亮、繁華，卻暗藏古老規矩與靈脈脈動。\n\n有人前往京都車站區域，挑戰那座看似普通的大階梯，卻不知自己正踏在妖族的數據散熱脈線上；也有人仰望京都塔，感受到主靈脈增幅器微弱的震動。\n往東走的隊員則踏入四條河原町的蜃氣樓商圈，讓狐妖們以時尚幻術與限定誘惑測試他們的意志力——在這裡，金錢即魔力，付出就能換取慾望。\n勇敢深入巷弄者，誤入新京極的回音迴廊，幸運的能遇見付喪神的惡作劇，倒楣的可能在時間錯位的幻境中多待幾分鐘——或幾個小時。\n也有隊員選擇回到據點休息，在安全結界中整理今日戰利品與心得，為隔日行程蓄力。\n\n⚠️ 請注意： 夜間靈脈雖美，但禁忌仍在。若氣息過度興奮、消費過量、或在鴨川邊與可疑旅人對視太久，都可能引來妖族的額外關注。記得準時返回據點，避免在妖都的夜色中迷失。', type: 'food' },
                        { id: 1506, time: '00:00', title: '第二夜．記錄與充電', desc: '【休息章：回憶存檔與能量補滿】夜深後，遠征隊逐一關上房內燈光，將白鷺城與勝尾寺的畫面寫入心中的冒險日誌，或記錄在魔導通訊石的影像與備忘錄中。隨著睡眠結界開啟，身體與魔力條緩慢回滿，精神疲勞度下降，為接下來的山區與神社行程做好準備。', type: 'hotel' },
                    ],
                    '2025-12-16': [
                        { id: 1601, time: '07:00', title: '飯店早餐．冒險前的補給之術', desc: '【補給之術：體力槽填滿】早晨在飯店享用早餐，從暖胃的湯品、麵包，到和風料理與蔬菜，都是遠征隊的基礎補給。這一餐直接決定今日的起始體力與專注力。吃飽喝足後，隊伍體力槽回滿，行動力 +120，抗寒與抗餓能力同步提升。\n\n⚠️ 備註：可多補充水分與蔬菜，以應付山區溫差與長時間行走。', type: 'food' },
                        { id: 1602, time: '09:00', title: '貴船神社．沿水而上的祈願之路', desc: '【靈脈探訪：水之神社】馬車出發後，隊伍沿著山路前進，抵達貴船神社。石階兩側的紅色燈籠與山間流水交錯成一條「沿水而上的靈脈導線」，彷彿引導旅人一步步走向祈願的核心。在此祈求旅程順利、人際關係和諧，可獲得期間限定「人際好感度＋」與「旅途順利」Buff。\n\n⚠️ 備註：冬季山區氣溫偏低，請注意保暖與鞋底防滑，以免在石階上觸發意外摔倒 Debuff。', type: 'sightseeing' },
                        { id: 1603, time: '11:30', title: '龍安寺．枯山水中的靜默思緒', desc: '【心靈副本：枯山水的謎題】龍安寺以枯山水庭園聞名，石與砂的排列猶如一幅沒有說明的謎題。遠征隊在此放慢腳步，靜靜坐下觀看，讓思緒與呼吸回到同一個平穩頻率。在這裡停留可獲得「心靈噪音 -20」、「專注力 +100」的被動效果。', type: 'sightseeing' },
                        { id: 1604, time: '13:00', title: '晴明神社．陰陽師守護的街角', desc: '【術士領域：陰陽師的結界】隊伍前往晴明神社，這裡是傳說中陰陽師安倍晴明的根據地。神社內隨處可見五芒星符號與各式符咒，一步步踏入，像是闖入古老術士的工作室。在此參拜可獲得「平安守護」與「驅邪加護」的狀態加成，對於在外旅行的冒險者而言，是非常實用的防禦 Buff。', type: 'sightseeing' },
                        { id: 1605, time: '13:45', title: '御金神社．金運加持的黃金結界', desc: '【財運任務：黃金鳥居的祝福】短暫步行後抵達御金神社，金色鳥居宛如金運結界入口，象徵財富與豐盛流動。遠征隊在此投下硬幣。為本次遠征以及未來投資與家宅祈求庇佑。於此祈願可觸發「金運小幅提升」與「家宅安穩」加成。\n\n⚠️ 備註：特別適合祈求財運、工作收入與家庭安定相關願望。', type: 'sightseeing' },
                        { id: 1606, time: '14:30', title: '二條城．沉睡將軍的歷史舞台', desc: '【歷史副本：將軍居所】進入二條城，腳步踩在會發出鶯聲的木地板上，彷彿聽見古代武士與將軍在廊道上穿梭的回音。壁畫、庭園與建築結構共同編織出一幅權力、審美與時代交錯的畫卷。遠征隊在此獲得「歷史理解 +50」、「空間感知 +20」的被動加成。\n\n⚠️ 備註：室內請留意參觀動線與現場規定，避免觸發工作人員提醒事件。', type: 'sightseeing' },
                        { id: 1607, time: '16:30', title: '高木批發超市三条店．零食風暴支線任務', desc: '【支線任務：補給倉庫突襲】傍晚來到高木批發超市三条店，這裡被傳為「零食與泡麵的寶庫」。走進店內，貨架宛如一排排等待被探索的寶箱，價格親切，是補充宵夜與伴手禮的黃金據點。成功掃貨後，隊伍「宵夜庫存量 +10000」、「旅途口糧安全感 +5000」。\n\n⚠️ 備註：記得開啟下方傳送門導航，避免在巷弄迷宮中迷路。', type: 'shop', link: 'https://maps.app.goo.gl/QiqSBbP7DtEsyLQV8?g_st=ic', linkText: '開啟導航' },
                        { id: 1608, time: '18:30', title: '歸返隱者之灯．滿載物資', desc: '【物資回收：據點再補滿】結束高木倉庫的掃貨任務後，馬車載著裝滿零食與補給品返回隱者之灯。雖然行李重量再度上升，但心情值與未來幾晚的滿足感也隨之提升。', type: 'transport' },
                        { id: 1609, time: '19:00', title: '自由夜行．在京都的街巷中徘徊', desc: '【夜間自由支線：各自探索】夜色覆上京都後，妖族與人類共存的現代都市真正甦醒。遠征隊進入「夜間自由支線時段」，城市的靈脈在此刻最為鮮明。\n\n有人步入京都高島屋——財祿狐商會總部，感受狐族巧妙地操控的「財祿流」，有旅人在此被選中、獲得提升購運的金運符；有人誤闖大丸‧衣紋妖的織氣塔，在纖維靈的注視下挑選服飾，衣物彷彿自己找到主人。\n更勇敢的探索者踏入唐吉軻德公會內的混沌市集，通道如迷宮般變換，引導旅人邂逅「剛好需要」的道具；也有人朝 Kiddy Land 夢境玩偶棲所前進，被夢靈選中的玩偶往往能帶來強化心情的 buff。\n若想平靜，隊員們會走向 BAL 靈感基地，在書靈的思念流中獲得靈感碎片；或漫步至 京都 LOFT，付喪神的多層棲地，與主動呼喚旅人的小物邂逅，開啟羈絆事件。\n\n也有冒險者選擇回到據點，在安全結界中拆零食、整理戰利品，讓今日的故事沉入心底。\n在妖都京都的夜裡，每個選擇，都會悄悄寫入今晚的個人傳說。', type: 'food' },
                        { id: 1610, time: '00:00', title: '第三夜．靈脈巡禮的冒險旅程暫時告一段落', desc: '【休息章：靈脈巡禮後的沈澱】經過一整天的神社與靈脈巡禮，身心都需要好好沈澱。遠征隊在各自房間的睡眠結界中安靜躺下，讓今天吸收的風景、故事與祈願慢慢沉入心底。體力條、魔力條再度回滿，為接下來的任天堂回憶神殿與宇治之行預做準備。', type: 'hotel' },
                    ],
                    '2025-12-17': [
                        { id: 1701, time: '全天', title: '與分隊會合．遠征隊正式完整編成', desc: '【羈絆任務：全員集結】今天是會合之日。分散在不同路線與時間抵達京都的成員陸續現身隱者之灯，重組為完整的遠征隊。大家彼此交換前幾日的戰利品、照片與奇聞趣事，隊伍羈絆值大幅提升，默契度 +3000，整體士氣 +2000。', type: 'hotel' },
                        { id: 1702, time: 'All Day', title: '自由漫步．各自完成想去的支線任務', desc: '【自由日任務：支線全面開放】這一天沒有硬性主線行程，每位成員都可以自由選擇想走的路線：有人前往寺社再訪、強化心靈 Buff；有人選擇百貨血拼、蒐集隨機寶箱與護具裝備；也有人只想找家咖啡店坐一下午，讓心靈與雙腳一起休息。所有選擇，都是旅程的一部分，請找尋屬於自己的冒險支線吧!!!\n\n⚠️ 備註：可與小隊討論行程，約好集合時間與安全聯絡方式，確保每位成員都能安全回到據點。', type: 'sightseeing' }
                    ],
                    '2025-12-18': [
                        { id: 1801, time: '09:00', title: '大廳集合．前往任天堂回憶神殿', desc: '【主線任務：冒險家聖地出發】早晨在飯店大廳集合後，遠征隊整隊出發，朝任天堂博物館前進。對許多成員而言，那裡是無數遊戲記憶與童年像素誕生的源頭，堪稱冒險家心中的回憶神殿。', type: 'transport' },
                        { id: 1802, time: '10:30', title: '任天堂博物館入場儀式', desc: '【入場儀式：回憶大門開啟】抵達任天堂博物館後，在入口完成票券檢查與入場手續。當大門緩緩打開，門後的每一個展區，都是不同比例尺的時間結晶，從 8-bit 到現代畫面，彷彿一條可行走的時間走廊。', type: 'ticket' },
                        { id: 1803, time: '11:00', title: '像素與記憶．任天堂世界探索', desc: '【探索副本：像素世界巡禮】遠征隊在展場中穿梭，與經典角色合影、回顧歷代主機與遊戲作品。從紅白機到現代主機，不同世代的記憶交織在同一個空間。這裡不只是展示空間，而是一場回到冒險家初心的朝聖旅程。笑聲與驚呼聲交織成一首 8-bit 與現代交響混音的 BGM。\n\n⚠️ 備註：請留意館內攝影規定與參觀動線，避免與其他隊伍互相阻擋。', type: 'sightseeing' },
                        { id: 1804, time: '14:45', title: '前往宇治．穿越到茶香與古橋之地', desc: '【轉場章：前往河畔小鎮】離開任天堂回憶神殿後，隊伍啟程前往宇治。魔導列車行駛間，窗外景色從都會街景逐漸轉為河川、小橋與低矮房舍，空氣中彷彿也染上了淡淡的茶香幻影。這是一段從像素世界回到自然河畔的調適旅程。', type: 'transport' },
                        { id: 1805, time: '15:15', title: '宇治川畔．平等院與鳳凰堂', desc: '【風景副本：鳳凰映水】抵達 JR 宇治站後，步行約 10 分鐘來到平等院。鳳凰堂倒映在池水中的景象，宛如從古畫中走出的建築幻影，時間在此似乎被放慢幾拍。這裡非常適合靜靜感受日本美學的細膩，將今日的感受刻在心底。\n\n⚠️ 備註：若時間允許，可沿著宇治川散步或品嚐抹茶甜點，為今日增加「甜點療癒度 +200」。', type: 'sightseeing' },
                        { id: 1806, time: '17:00', title: '返回京都．黃昏中的回程列車', desc: '【回程章：風景收束時刻】夕陽染上車窗與河面，遠征隊搭乘魔導列車返回京都據點。這段列車旅程，是讓今日的畫面慢慢從視覺轉為記憶的黃金時段，所有風景都在心中悄悄歸檔。', type: 'transport' },
                        { id: 1807, time: '19:20', title: '裏五十棲聚餐．夜色中的饗宴', desc: '【羈絆宴會：隊伍交流時間】在大廳集合後，參加聚餐成員一同前往裏五十棲用餐。桌上料理熱氣與酒杯碰撞聲交織，搭配笑聲與分享旅程故事，構成遠征期間極為重要的「羈絆交流時間」。隊伍感情度 +1300，回憶共同度 +2500。\n\n⚠️ 備註：未參加聚餐者則保留自由活動時間，可自行安排晚餐與行程，但仍建議留意安全與返回時間。', type: 'food' }
                    ],
                    '2025-12-19': [
                        { id: 1901, time: '08:00', title: '冒險者的自由時光：終章前的探索', desc: '【終章前自由探索：最後衝刺日】在正式邁入旅程終章前，這是冒險者最後一次任意探索未完成支線與遺珠地點的黃金時段。這一天完全交給「騎士團討伐魔王遠征隊」自由支配。可以補足尚未完成的清單：補貨、再訪喜歡的街區、到河岸邊發呆或單純拍照留念，讓旅程節奏再慢下來一次，為結局預留一點餘韻。\n\n⚠️ 備註：建議預留體力與時間，避免晚間集合與夜間行程出現趕場與疲勞過度的情況。', type: 'sightseeing' },
                        { id: 1902, time: '17:45', title: '鳥貴族集結．木屋町通店前的待機點', desc: '【晚宴前集結：河畔集合點】傍晚於指定地點集合，準備前往鳥貴族木屋町通店。沿著鴨川與木屋町一帶前進，街燈與店家招牌一一點亮，京都夜晚的另一種樣貌也隨之登場。\n\n這裡是今晚慶功宴開場前的重要待機點。\n\n⚠️ 備註：下方傳送門為官方地圖頁，建議提前確認路線，避免在小巷迷宮中迷路。', type: 'transport', link: 'https://map.torikizoku.co.jp/detail/377/', linkText: '地圖傳送門' },
                        { id: 1903, time: '18:00', title: '鳥貴族吃到飽．歡笑與乾杯的夜宴', desc: '【慶功副本：吃到飽盛宴】在鳥貴族木屋町通店展開吃到飽模式，桌上串燒與飲品源源不絕地上桌。遠征隊在此放鬆防備，敞開胃袋與笑容，為這趟旅程舉杯慶祝。這一晚，是旅程中笑聲最密集的片段之一，羈絆度 +40，飽食度 +100。\n\n⚠️ 備註：請注意酒量與身體狀況，保持安全與理性，避免觸發「隔天宿醉」Debuff。', type: 'food' },
                        { id: 1904, time: '20:00', title: '羅森道具屋&唐吉軻德公會 最後衝刺', desc: '【終盤採購任務：戰利品補完計畫】晚餐後前往道具屋與公會地下市集進行最後採買，補完伴手禮清單與那些先前猶豫沒買的心願品項。這是整理願望清單、補完所有遺珠戰利品的最後機會。完成後，可獲得「購物滿足度 +100000」與「行李塞滿指數 +2000」。', type: 'shop' },
                        { id: 1905, time: '00:00', title: '整理行囊．為歸國做準備', desc: '【歸途前的整備】回到隱者之灯後，遠征隊開始返航前的整備。行李箱打開，來自大阪迷宮的戰利品─心齋橋獸族領地的幻術系裝備、日本橋魔族地盤的稀有道具─與京都妖都靈脈的各式紀念物，依序被重新分類、收納與封印。\n\n在心齋橋面對大Boss招牌的霓虹壓迫、在日本橋魔力濃度爆表的街道獵寶、在四條河原町被狐族的財祿流Buff影響金錢運勢、在新京極回音迴廊差點迷失時間─以及在妖族與人類共存的京都夜色下所聽見的脈動，都逐一沉入行李的夾層中。\n\n這道整備並非單純的物品整理，而是將兩座城市的冒險篇章封存的儀式。當拉鍊扣上，象徵 「大阪迷宮篇」與「京都妖都篇」 正式告一段落，遠征隊已準備迎接明日的返航節點。\n\n⚠️ 備註： 請再次確認行李重量與液體規則，避免在空港觸發「超重費用」或「安檢退貨」事件。', type: 'hotel' }
                    ],
                    '2025-12-20': [
                        { id: 2001, time: '09:30', title: '列隊歡送．分隊歸國', desc: '【前線隊伍輪替：分隊先行返陣】\n清晨，遠征隊在隱者之灯房門前集合，為先行返回桃園前哨站的分隊進行簡短的出發告別。這不是儀式，而是冒險者之間的禮節——揮手、碰拳、擁抱與合照，象徵遠征隊即將進入尾聲段落，也替下一次共同出征埋下「再度集結」的契約。\n\n⚠️ 建議： 此時是拍攝全隊大合照的最佳時刻，可記錄本次遠征的完整隊形。', type: 'hotel' },
                        { id: 2002, time: '09:45', title: '退房手續．離開京都', desc: '【據點閉鎖：隱者之灯的任務完成】\n隊伍回到大廳，辦理退房手續。當鑰匙交回櫃檯的瞬間，象徵這座臨時建立的冒險據點「隱者之灯」已完成它在旅程中的使命。儘管據點在地圖上被標記為「已關閉」，但它已在隊伍心中登錄成永久的記憶坐標。', type: 'hotel' },
                        { id: 2003, time: '10:00', title: '前往 OUTLET．最後的購物戰場', desc: '【終盤戰場：資源與欲望的最終抉擇】\n遠征隊離開隱者之灯，搭乘交通隊伍前往 OUTLET 終盤區域。車上討論聲不斷——未完成的清單、必買的稀有裝備、最後能使用的加隆。此刻的隊伍像是準備踏入冒險最後的資源戰區，每個人都握著自己剩餘的「財富值」。', type: 'transport' },
                        { id: 2004, time: '11:30', title: 'OUTLET 大決戰．終盤戰利品收集', desc: '【最終尋寶層：戰利品收集挑戰】\nOUTLET 被視為旅程的「BOSS寶箱尋寶層」。此地擁有高密度的商店魔力場，冒險者可在此進行最後的裝備補強：武器與防具、魔杖、特殊道具卷軸、魔導核心、次元袋、心靈與 Buff 系道具。\n\n每位隊員需在「預算值」「行囊負重」「理智條」三項屬性間進行平衡判定，才能成功獲得最適合自己的戰利品。此地取得的每一件物品，都將作為遠征結束後的「記憶具現道具」。\n\n⚠️ 提示： 請預留移動與寄物時間，避免觸發「時間不足」的強制移動事件。', type: 'shop' },
                        { id: 2005, time: '15:40', title: '寄物櫃前集合．整理戰利品', desc: '【整隊點：戰利品盤點區】\n遠征隊在寄物櫃前會合，清點從終盤層帶回的戰利品，並重新分配至托運或手提行囊。這是撤離前最後的盤點，也是確認「無遺失、無掉落」的最終機會。', type: 'hotel' },
                        { id: 2006, time: '16:05', title: '搭乘臨空城接駁車．前往機場', desc: '【轉移章：通往終點關卡】\n隊伍搭上接駁車，沿著海岸線駛向 關西海上要塞空港。窗外景色宛如一段緩慢播放的旅程 Ending，彷彿在提醒隊員們：冒險即將進入存檔畫面。', type: 'transport' },
                        { id: 2007, time: '16:25', title: '機場待機．整理記憶與通關手續', desc: '【終章前準備：通關、休整與回憶】\n抵達 關西海上要塞空港後，隊伍進行報到、托運與出境結界流程。剩餘時間可購買最後的結界小物、整頓心情，或靜靜瀏覽旅途中拍下的記憶影像。這段等待，是遠征故事的柔和逗點，而非句點。', type: 'transport' },
                        { id: 2008, time: '18:20', title: '歸鄉之翼．從關西返航桃園', desc: '【最終章：回到原點的存檔】\n18:20 開始登上歸鄉之翼，19:00 自關西海上要塞空港起航。鐵翼穿越夜空，朝桃園前哨站前進。約 21:15 著陸——當機輪觸地的瞬間，本次「騎士團討伐魔王遠征」正式存檔完成。\n\n旅程在地圖上結束，但冒險者心中的劇本，正準備迎接下一章。', type: 'transport' }
                    ]
                });

                const coinTabs = [
                    { id: 'ledger', label: '記帳', icon: 'fa-solid fa-book-open' },
                    { id: 'stats', label: '分析', icon: 'fa-solid fa-chart-pie' },
                    { id: 'settings', label: '匯率', icon: 'fa-solid fa-sliders' },
                ];
                const chapters = [
                    { id: 'ch1', label: '第一章', dateShort: '12/14', fullTitle: '12/14 第一章：異界之門' },
                    { id: 'ch2', label: '第二章', dateShort: '12/15', fullTitle: '12/15 第二章：白鷺與達摩' },
                    { id: 'ch3', label: '第三章', dateShort: '12/16', fullTitle: '12/16 第三章：靈山與神靈' },
                    { id: 'ch4', label: '第四章', dateShort: '12/17', fullTitle: '12/17 第四章：騎士們的休日' },
                    { id: 'ch5', label: '第五章', dateShort: '12/18', fullTitle: '12/18 第五章：神殿與鳳凰' },
                    { id: 'ch6', label: '第六章', dateShort: '12/19', fullTitle: '12/19 第六章：最終饗宴' },
                    { id: 'ch7', label: '終章', dateShort: '12/20', fullTitle: '12/20 終章：回憶與寶藏' },
                ];
                const expenseCategories = [
                    { val: 'potion', label: '道具屋(藥瓶)', icon: 'fa-solid fa-flask', color: '#34d399' },
                    { val: 'food', label: '魔法料理(雞腿)', icon: 'fa-solid fa-drumstick-bite', color: '#fb923c' },
                    { val: 'transport', label: '移動法陣', icon: 'fa-solid fa-circle-notch', color: '#60a5fa' },
                    { val: 'gear', label: '裝備護具(盾)', icon: 'fa-solid fa-shield-halved', color: '#9ca3af' },
                    { val: 'drugstore', label: '煉金藥水(面具)', icon: 'fa-solid fa-mask', color: '#10b981' },
                    { val: 'ticket', label: '結界通行證', icon: 'fa-solid fa-ticket', color: '#f87171' },
                    { val: 'gacha', label: '隨機寶箱(扭蛋)', icon: 'fa-solid fa-dice-d20', color: '#facc15' },
                    { val: 'gift', label: '羈絆道具(禮物)', icon: 'fa-solid fa-gift', color: '#f472b6' },
                    { val: 'quest', label: '支線任務(卷軸)', icon: 'fa-solid fa-scroll', color: '#94a3b8' },
                    { val: 'hotel', label: '隱者之灯(小屋)', icon: 'fa-solid fa-tent', color: '#818cf8' },
                ];
                const expenses = ref([
                    { id: 1, chapterId: 'ch1', type: 'quest', title: '行李特工', yen: 2624, twd: 538, payment: 'cash', note: '' },
                    { id: 2, chapterId: 'ch1', type: 'hotel', title: 'FORZA KYOTO飯店', yen: 35005, twd: 7176, payment: 'cash', note: '' },
                    { id: 3, chapterId: 'ch1', type: 'quest', title: '公積金', yen: 30000, twd: 6150, payment: 'cash', note: '' },
                    { id: 4, chapterId: 'ch2', type: 'transport', title: '包車', yen: 8500, twd: 1743, payment: 'cash', note: '' },
                    { id: 5, chapterId: 'ch3', type: 'transport', title: '包車', yen: 7500, twd: 1538, payment: 'cash', note: '' },
                    { id: 6, chapterId: 'ch5', type: 'ticket', title: '任天堂博物館門票', yen: 3390, twd: 695, payment: 'cash', note: '' },
                    { id: 7, chapterId: 'ch6', type: 'food', title: '鳥貴族吃到飽', yen: 2800, twd: 574, payment: 'cash', note: '' },
                    { id: 8, chapterId: 'ch7', type: 'transport', title: '包車', yen: 3500, twd: 718, payment: 'cash', note: '' },
                ]);

                // --- Methods (Journal) ---
                const currentEvents = computed(() => itineraryData.value[selectedDate.value] || []);
                const selectDay = (date) => { selectedDate.value = date; nextTick(() => initSortable()); };
                const getChapterTitle = (date) => days.find(d => d.date === date)?.chapter || '';
                const getChapterSubtitle = (date) => days.find(d => d.date === date)?.subtitle || '';
                const getCategoryColor = (type) => ({ sightseeing: 'border-l-purple-400', transport: 'border-l-blue-400', food: 'border-l-orange-400', shop: 'border-l-yellow-400', hotel: 'border-l-indigo-400', ticket: 'border-l-red-400' }[type] || 'border-l-white');
                const getCategoryIcon = (type) => eventTypes.find(t => t.val === type)?.icon || 'fa-solid fa-circle';
                
                let sortableInstance = null;
                const initSortable = () => {
                    const list = itineraryData.value[selectedDate.value];
                    if (!list || list.length === 0) {
                        if (sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }
                        return;
                    }
                    const el = document.getElementById('itinerary-list');
                    if (!el) return;
                    if (sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }
                    sortableInstance = new Sortable(el, {
                        animation: 200, delay: 200, delayOnTouchOnly: true, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                        onEnd(evt) {
                            const arr = itineraryData.value[selectedDate.value];
                            if (!arr) return;
                            const oldIndex = evt.oldIndex; const newIndex = evt.newIndex;
                            if (oldIndex == null || newIndex == null || oldIndex === newIndex) return;
                            const [moved] = arr.splice(oldIndex, 1);
                            arr.splice(newIndex, 0, moved);
                        },
                    });
                };
                const openAddModal = () => {
                    modalMode.value = 'add';
                    editingEvent.value = { id: Date.now(), time: '', title: '', desc: '', type: 'sightseeing', link: '', linkText: '' };
                    confirmDelete.value = false;
                    isModalOpen.value = true;
                };
                const editEvent = (event) => { modalMode.value = 'edit'; editingEvent.value = { ...event }; confirmDelete.value = false; isModalOpen.value = true; };
                const closeModal = () => isModalOpen.value = false;
                const saveEvent = () => {
                    if (!editingEvent.value.title) return alert('請輸入標題');
                    if (modalMode.value === 'add') {
                        if (!itineraryData.value[selectedDate.value]) itineraryData.value[selectedDate.value] = [];
                        itineraryData.value[selectedDate.value].push({ ...editingEvent.value });
                    } else {
                        const list = itineraryData.value[selectedDate.value];
                        const index = list.findIndex(e => e.id === editingEvent.value.id);
                        if (index !== -1) list[index] = { ...editingEvent.value };
                    }
                    closeModal();
                    nextTick(() => initSortable());
                };
                const handleDelete = () => {
                    if (!confirmDelete.value) { confirmDelete.value = true; return; }
                    const list = itineraryData.value[selectedDate.value];
                    const index = list.findIndex(e => e.id === editingEvent.value.id);
                    if (index !== -1) list.splice(index, 1);
                    closeModal();
                    nextTick(() => initSortable());
                };

                // --- Computed & Methods (Coins) ---
                const currentChapterExpenses = computed(() => expenses.value.filter(e => e.chapterId === selectedChapter.value));
                const currentChapterInfo = computed(() => chapters.find(c => c.id === selectedChapter.value) || {});
                const todayTotalYen = computed(() => currentChapterExpenses.value.reduce((sum, e) => sum + e.yen, 0));
                const todayTotalTWD = computed(() => Math.round(todayTotalYen.value * exchangeRate.value));
                const grandTotalTWD = computed(() => Math.round(expenses.value.reduce((sum, e) => sum + e.yen, 0) * exchangeRate.value));
                const calculatedTWD = computed(() => (!editingExpense.value.yen) ? 0 : Math.round(editingExpense.value.yen * exchangeRate.value));

                const magicSummaryQuote = computed(() => {
                    const amount = todayTotalTWD.value;
                    if (amount < 1000) return '錢袋深處傳來規律的打呼聲，這點微小的加隆對小精靈毫無干擾。';
                    if (amount < 5000) return '小精靈熟練地數出相應的加隆，並對這次的交易點頭表示認可。';
                    if (amount < 10000) return '交出加隆時，小精靈的手指稍微用力捏了一下，眼神充滿了不捨。';
                    if (amount < 20000) return '錢袋精靈正死命拉緊束口繩，滿頭大汗地試圖阻止加隆外流！';
                    return '加隆如潰堤的洪水般傾瀉而下，連錢袋精靈都被這股金幣洪流沖走了。';
                });

                const pieChartData = computed(() => {
                    const stats = {}; let total = 0;
                    expenses.value.forEach(e => {
                        if (!stats[e.type]) stats[e.type] = 0;
                        stats[e.type] += e.yen;
                        total += e.yen;
                    });
                    return Object.keys(stats).map(type => {
                        const cat = expenseCategories.find(c => c.val === type);
                        return {
                            type, label: cat ? cat.label : type, color: cat ? cat.color : '#ccc',
                            percent: (stats[type] / total) * 100, value: stats[type]
                        };
                    }).sort((a, b) => b.value - a.value);
                });

                const pieChartGradient = computed(() => {
                    let gradient = 'conic-gradient('; let currentAngle = 0;
                    pieChartData.value.forEach((d) => {
                        const start = currentAngle; const end = currentAngle + d.percent;
                        gradient += `${d.color} ${start}% ${end}%, `; currentAngle = end;
                    });
                    return gradient.slice(0, -2) + ')';
                });

                const lineChartData = computed(() => {
                    return chapters.map(chap => {
                        const total = expenses.value.filter(e => e.chapterId === chap.id).reduce((sum, e) => sum + e.yen, 0);
                        return { id: chap.id, val: Math.round(total * exchangeRate.value) };
                    });
                });

                const lineChartPath = computed(() => {
                    const data = lineChartData.value;
                    const max = Math.max(...data.map(d => d.val), 100);
                    const width = 100; const height = 100; const step = width / (data.length - 1);
                    let d = `M 0 ${height - (data[0].val / max * height * 0.8)}`;
                    data.forEach((p, i) => {
                        if (i === 0) return;
                        const x = i * step; const y = height - (p.val / max * height * 0.8);
                        const prevX = (i - 1) * step; const prevY = height - (data[i-1].val / max * height * 0.8);
                        const cp1x = prevX + (x - prevX) / 2; const cp1y = prevY;
                        const cp2x = prevX + (x - prevX) / 2; const cp2y = y;
                        d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x} ${y}`;
                    });
                    return d;
                });

                const lineChartAreaPath = computed(() => `${lineChartPath.value} L 100 100 L 0 100 Z`);
                const lineChartDots = computed(() => {
                    const data = lineChartData.value;
                    const max = Math.max(...data.map(d => d.val), 100);
                    const width = 100; const step = width / (data.length - 1);
                    return data.map((d, i) => ({ x: i * step, y: 100 - (d.val / max * 100 * 0.8) }));
                });

                const formatMoney = (val) => val ? val.toLocaleString() : '0';
                const getExpenseIcon = (type) => expenseCategories.find(c => c.val === type)?.icon || 'fa-solid fa-circle';
                const getExpenseLabel = (type) => expenseCategories.find(c => c.val === type)?.label || type;
                const getPaymentIcon = (pay) => ({ cash: 'fa-solid fa-coins', card: 'fa-regular fa-credit-card', suica: 'fa-solid fa-train' }[pay] || 'fa-solid fa-wallet');
                const getChapterTotal = (chapId) => Math.round(expenses.value.filter(e => e.chapterId === chapId).reduce((sum, e) => sum + e.yen, 0) * exchangeRate.value);
                const getChapterSummarySentence = (chapId) => {
                    const exps = expenses.value.filter(e => e.chapterId === chapId);
                    if (exps.length === 0) return '本章節尚未紀錄任何支出．加隆小精靈酣然沉睡';
                    const counts = {}; exps.forEach(e => counts[e.type] = (counts[e.type] || 0) + e.yen);
                    const topType = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                    const catLabel = expenseCategories.find(c => c.val === topType)?.label.split('(')[0] || '未知';
                    return `以『${catLabel}』為主軸的加隆消耗日`;
                };

                const openExpenseModal = (mode) => {
                    expenseModalMode.value = mode; confirmDeleteExpense.value = false;
                    if (mode === 'add') { editingExpense.value = { id: Date.now(), chapterId: selectedChapter.value, type: 'potion', title: '', yen: null, twd: 0, payment: 'cash', note: '' }; }
                    isExpenseModalOpen.value = true;
                };
                const editExpense = (exp) => { expenseModalMode.value = 'edit'; confirmDeleteExpense.value = false; editingExpense.value = { ...exp }; isExpenseModalOpen.value = true; };
                const closeExpenseModal = () => isExpenseModalOpen.value = false;
                const saveExpense = () => {
                    if (!editingExpense.value.yen) return;
                    if (expenseModalMode.value === 'add') {
                        expenses.value.push({ ...editingExpense.value, twd: Math.round(editingExpense.value.yen * exchangeRate.value) });
                    } else {
                        const idx = expenses.value.findIndex(e => e.id === editingExpense.value.id);
                        if (idx !== -1) expenses.value[idx] = { ...editingExpense.value, twd: Math.round(editingExpense.value.yen * exchangeRate.value) };
                    }
                    closeExpenseModal();
                };
                // 1. 按下垃圾桶 Icon：只打開確認視窗 
                const requestDelete = () => { 
                        showDeleteConfirm.value = true; 
                 }; 

               // 2. 按下「遺忘咒」：真的刪除資料 
              const confirmDeleteAction = () => { 
                     const idx = expenses.value.findIndex(e => e.id === editingExpense.value.id); 
                     if (idx !== -1) expenses.value.splice(idx, 1); 
                     showDeleteConfirm.value = false; // 關閉確認窗 
                     closeExpenseModal(); // 關閉編輯窗 
               };

                // Watchers & Mounted
                onMounted(() => {
                    setTimeout(() => isLoading.value = false, 1500);
                    nextTick(() => initSortable());
                });

                watch(currentTab, (newVal) => {
                    if (newVal === 'journal') nextTick(() => initSortable());
                    else if (sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }
                });
                watch(selectedDate, () => nextTick(() => initSortable()));

// ==========================================
                // ★★★ 步驟 2 & 3：記憶魔法與重置功能 ★★★
                // ==========================================
                
                const STORAGE_KEY = 'rpg-expedition-save-v1'; // 這是存檔在瀏覽器的暗號

                // 定義我們要監聽並存檔的資料
                const stateToSave = computed(() => ({
                    itineraryData: itineraryData.value,     // 行程表
                    expenses: expenses.value,               // 記帳資料
                    checklistItems: checklistItems.value,   // 行前清單
                    bagMemo: bagMemo.value,                 // 備忘錄
                    exchangeRate: exchangeRate.value,       // 匯率設定
                }));

                // 讀取魔法：網頁一打開，就去問瀏覽器「有沒有存檔？」
                const loadFromStorage = () => {
                    const savedData = localStorage.getItem(STORAGE_KEY);
                    if (savedData) {
                        try {
                            const parsed = JSON.parse(savedData);
                            // 如果有存檔，就用存檔覆蓋掉預設值
                            if (parsed.itineraryData) itineraryData.value = parsed.itineraryData;
                            if (parsed.expenses) expenses.value = parsed.expenses;
                            if (parsed.checklistItems) checklistItems.value = parsed.checklistItems;
                            if (parsed.bagMemo) bagMemo.value = parsed.bagMemo;
                            if (parsed.exchangeRate) exchangeRate.value = parsed.exchangeRate;
                            console.log('📖 成功讀取冒險紀錄！');
                        } catch (e) {
                            console.error('讀取失敗，使用預設值', e);
                        }
                    }
                };

                // 立即執行讀取
                loadFromStorage();

                // 存檔魔法：只要資料一變動，就自動存檔 (Auto Save)
                watch(stateToSave, (newVal) => {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(newVal));
                }, { deep: true });

                // 重置按鈕的功能：清除存檔並重新整理
                const resetData = () => {
                    if(confirm('確定要銷毀所有紀錄，重置回初始狀態嗎？\n(此動作無法復原，會變回預設行程)')) {
                        localStorage.removeItem(STORAGE_KEY);
                        location.reload(); // 重新整理網頁
                    }
                };
                
                // ==========================================
                // ★★★ 程式碼結束 ★★★
                // ==========================================


              return {
                    isLoading, currentTab,
                    // Shared
                    tabs, weatherForecast, headerTitle, headerSubtitle, headerIcon,
                    
                    // AI / Cat
                    apiKey, chatInput, chatHistory, isSummoning, summonFamiliar, showChatModal, toggleAI,
                    
                    // Journal (冒險日誌)
                    days, selectedDate, selectDay, getChapterTitle, getChapterSubtitle, currentEvents, getCategoryColor, getCategoryIcon,
                    isModalOpen, openAddModal, editEvent, closeModal, saveEvent, editingEvent, eventTypes, modalMode, handleDelete, confirmDelete,
                    
                    // Guild & Supply (公會與補給)
                    guildSubTab, guildData, guildTabs, selectedLayer, currentLayerData, selectedKyotoLayer, currentKyotoData,
                    supplySubTab, supplyTabs, currentSupplyList,
                    
                    // Coins (加隆/記帳) - 關鍵修復區
                    coinSubTab, coinTabs, chapters, selectedChapter, expenses, currentChapterExpenses, todayTotalTWD, todayTotalYen, grandTotalTWD, magicSummaryQuote,
                    formatMoney, getExpenseIcon, getExpenseLabel, getPaymentIcon, 
                    
                    // 記帳視窗開關與功能
                    isExpenseModalOpen, openExpenseModal, editExpense, closeExpenseModal, saveExpense, 
                    
                    // 刪除確認 (遺忘咒) 功能
                    showDeleteConfirm, requestDelete, confirmDeleteAction,
                    
                    // 其他記帳變數
                    expenseModalMode, editingExpense, expenseCategories, confirmDeleteExpense, exchangeRate, lastRateUpdate, calculatedTWD,
                    
                    // 圖表變數
                    pieChartData, pieChartGradient, lineChartPath, lineChartAreaPath, lineChartDots, getChapterTotal, getChapterSummarySentence, currentChapterInfo,
                    
                    // Bag (行囊) & 重置
                    bagMemo, checklistItems,
                    resetData
                };
            }
        }).mount('#app');
    </script>


